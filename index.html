<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calendario dell'Avvento - Costellazioni</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      /* Primitive Color Tokens */
      --color-white: rgba(255, 255, 255, 1);
      --color-black: rgba(0, 0, 0, 1);
      --color-cream-50: rgba(252, 252, 249, 1);
      --color-cream-100: rgba(255, 255, 253, 1);
      --color-gray-200: rgba(245, 245, 245, 1);
      --color-gray-300: rgba(167, 169, 169, 1);
      --color-gray-400: rgba(119, 124, 124, 1);
      --color-slate-500: rgba(98, 108, 113, 1);
      --color-brown-600: rgba(94, 82, 64, 1);
      --color-charcoal-700: rgba(31, 33, 33, 1);
      --color-charcoal-800: rgba(38, 40, 40, 1);
      --color-slate-900: rgba(19, 52, 59, 1);
      --color-teal-300: rgba(50, 184, 198, 1);
      --color-teal-400: rgba(45, 166, 178, 1);
      --color-teal-500: rgba(33, 128, 141, 1);
      --color-teal-600: rgba(29, 116, 128, 1);
      --color-teal-700: rgba(26, 104, 115, 1);
      --color-teal-800: rgba(41, 150, 161, 1);
      --color-red-400: rgba(255, 84, 89, 1);
      --color-red-500: rgba(192, 21, 47, 1);
      --color-orange-400: rgba(230, 129, 97, 1);
      --color-orange-500: rgba(168, 75, 47, 1);

      /* Christmas colors */
      --christmas-red: #8B0000;
      --christmas-green: #228B22;
      --christmas-gold: #FFD700;
      --christmas-silver: #C0C0C0;
      --winter-blue: #4169E1;
    }
    
    body {
      background: linear-gradient(135deg, #000428 0%, #004e92 100%);
      min-height: 100vh;
      overflow-x: hidden;
    }
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: -1;
    }
    .stars, .snow {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: transparent;
      overflow: hidden;
      z-index: -1;
      pointer-events: none;
    }
    .star, .flake {
      position: absolute;
      border-radius: 50%;
      opacity: 0.8;
    }
    .star {
      width: 2px;
      height: 2px;
      background: white;
      animation: twinkle 2s infinite ease-in-out;
    }
    @keyframes twinkle {
      0%, 100% { opacity: 0.2; }
      50% { opacity: 1; }
    }
    .flake {
      width: 6px;
      height: 6px;
      background: white;
      opacity: 0.7;
      animation: fall linear infinite;
    }
    @keyframes fall {
      0% { transform: translateY(-10px); opacity: 0; }
      20% { opacity: 1; }
      100% { transform: translateY(100vh); opacity: 0; }
    }

    .celebration {
      animation: glow 1s ease-in-out infinite alternate;
    }
    @keyframes glow {
      from { box-shadow: 0 0 10px #fbbf24, 0 0 20px #fbbf24; }
      to { box-shadow: 0 0 20px #f59e0b, 0 0 30px #f59e0b; }
    }

    .full-screen-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 50;
      padding: 2rem;
      overflow-y: auto;
      animation: fadeIn 0.3s ease-in-out;
    }
    .close-button {
      position: absolute;
      top: 1rem;
      right: 1rem;
      font-size: 2rem;
      cursor: pointer;
      background: none;
      border: none;
      color: white;
      transition: transform 0.2s ease;
    }
    .close-button:hover {
      transform: scale(1.2);
      color: #f87171;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .modal-content {
      animation: slideUp 0.3s ease-in-out;
      max-width: 700px;
      width: 100%;
      background: #1f2937;
      border-radius: 1rem;
      padding: 2rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.6);
    }
    .option-button {
      transition: all 0.2s ease;
    }
    .option-button:hover {
      transform: scale(1.05);
    }
    .feedback {
      margin-top: 1rem;
      font-size: 1.1rem;
      font-weight: bold;
      text-align: center;
    }
    .feedback.correct { color: #4ade80; }
    .feedback.wrong { color: #f87171; }
    
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background: #1f2937;
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 0.5rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.6);
      animation: slideInRight 0.3s ease-out;
    }
    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    

    

    

    




    /* Christmas Card Styles */
    .christmas-card {
      background: linear-gradient(135deg, var(--christmas-red) 0%, var(--christmas-green) 100%);
      border: 2px solid var(--christmas-gold);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 215, 0, 0.2);
      transition: all 0.3s ease;
    }
    
    .christmas-card:hover {
      transform: translateY(-5px) scale(1.02);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4), 0 0 30px rgba(255, 215, 0, 0.4);
    }
    
    .christmas-card.completed {
      background: linear-gradient(135deg, var(--christmas-gold) 0%, #ffa500 100%);
      animation: sparkle 2s infinite ease-in-out;
    }
    
    @keyframes sparkle {
      0%, 100% { box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 215, 0, 0.3); }
      50% { box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3), 0 0 40px rgba(255, 215, 0, 0.6); }
    }
    
    /* Header Styles */
    .app-header {
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 215, 0, 0.3);
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .header-title {
      color: var(--christmas-gold);
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
      font-family: serif;
    }
    

    
    /* Calendar Grid Styles */
    #calendarGrid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      padding: 1rem;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .calendar-day {
      padding: 1.5rem;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    
    .calendar-day.available {
      background: linear-gradient(135deg, #4ade80 0%, #22d3ee 100%);
      color: white;
      border-color: rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 15px rgba(34, 211, 238, 0.3);
    }
    
    .calendar-day.locked {
      background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
      color: #9ca3af;
      cursor: not-allowed;
      opacity: 0.7;
    }
    
    .calendar-day.completed {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: #1f2937;
      border-color: #fbbf24;
      box-shadow: 0 4px 15px rgba(251, 191, 36, 0.4);
      animation: sparkle 2s infinite ease-in-out;
    }
    
    .calendar-day:hover.available {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 8px 25px rgba(34, 211, 238, 0.4);
    }
    
    .calendar-day:hover.completed {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 8px 25px rgba(251, 191, 36, 0.5);
    }
    
    .calendar-day h2 {
      font-size: 1.25rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    
    .calendar-day .day-icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    
    .calendar-day .day-status {
      font-size: 0.875rem;
      font-weight: 600;
    }
    
    @media (max-width: 768px) {
      #calendarGrid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
        padding: 0.75rem;
      }
      
      .calendar-day {
        padding: 1rem;
        min-height: 100px;
      }
    }
    
    @media (max-width: 480px) {
      #calendarGrid {
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
        padding: 0.5rem;
      }
      
      .calendar-day {
        padding: 0.75rem;
        min-height: 80px;
      }
      
      .calendar-day h2 {
        font-size: 1rem;
      }
      
      .calendar-day .day-icon {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body class="text-white min-h-screen flex flex-col items-center p-4 overflow-y-auto relative">
  <div class="overlay"></div>
  <div class="stars" id="stars"></div>
  <div class="snow" id="snow"></div>

  <!-- Main App Content -->
  <div id="mainApp" class="w-full max-w-6xl relative z-10">
    <!-- App Header -->
    <div class="app-header">
      <div class="flex justify-center items-center">
        <div class="text-center">
          <h1 class="header-title text-4xl font-extrabold mb-2">üéÑ Calendario dell'Avvento - Costellazioni ‚ú®</h1>
          <h2 id="totalScore" class="text-2xl font-semibold text-white">‚≠ê Punteggio Totale: 0</h2>
        </div>
      </div>
    </div>
  </div>

  <div id="app" class="w-full max-w-6xl relative z-10"></div>
  
  <!-- Toast Container -->
  <div id="toast-container"></div>

  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script>
    // Stelle scintillanti
    const starContainer = document.getElementById('stars');
    for (let i = 0; i < 150; i++) {
      const star = document.createElement('div');
      star.classList.add('star');
      star.style.top = Math.random() * 100 + '%';
      star.style.left = Math.random() * 100 + '%';
      starContainer.appendChild(star);
    }
    // Fiocchi di neve
    const snowContainer = document.getElementById('snow');
    for (let i = 0; i < 50; i++) {
      const flake = document.createElement('div');
      flake.classList.add('flake');
      flake.style.left = Math.random() * 100 + '%';
      flake.style.animationDuration = 5 + Math.random() * 5 + 's';
      flake.style.animationDelay = Math.random() * 5 + 's';
      snowContainer.appendChild(flake);
    }

    const { useState, useEffect } = React;

    // App semplificata - no sistema utenti

    // ========================================
    // SISTEMA SALVATAGGIO CON LOCALSTORAGE
    // ========================================
    
    // ‚≠ê AGGIUNGERE TUTTO QUESTO BLOCCO ‚≠ê
    const STORAGE_KEY = 'calendarioAvventoProgress';
    
    function loadProgressFromStorage() {
      try {
        const savedData = localStorage.getItem(STORAGE_KEY);
        if (savedData) {
          const loadedData = JSON.parse(savedData);
          console.log('‚úÖ Progressi caricati da localStorage:', loadedData);
          return loadedData;
        }
      } catch (error) {
        console.error('‚ùå Errore nel caricamento da localStorage:', error);
      }
      return {};
    }
    
    function saveProgressToStorage() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(gameProgress));
        console.log('üíæ Progressi salvati in localStorage:', gameProgress);
      } catch (error) {
        console.error('‚ùå Errore nel salvataggio in localStorage:', error);
      }
    }
    // ‚≠ê FINE DEL BLOCCO DA AGGIUNGERE ‚≠ê
    
    let gameProgress = loadProgressFromStorage(); // Carica dati salvati

    let totalGameScore = 0; // Punteggio totale in memoria

    // ========================================
    // SALVATAGGIO SEMPLIFICATO - MEMORIA JAVASCRIPT
    // ========================================
    function saveProgress(dayIndex, finalScore, attempts, hintsUsed) {
    gameProgress[dayIndex] = {
      solved: true,
      finalScore: finalScore,
      attempts: attempts,
      hintsUsed: hintsUsed,
      completedAt: new Date().toISOString()
    };
    console.log(`üíæ Progresso salvato giorno ${dayIndex + 1}:`, gameProgress[dayIndex]);
    
    saveProgressToStorage(); // ‚≠ê AGGIUNGERE QUESTA RIGA ‚≠ê
  }


    function loadProgress() {
      return { ...gameProgress }; // Copia dell'oggetto in memoria
    }

    function getTotalScore() {
      return Object.values(gameProgress).reduce((sum, day) => sum + (day.finalScore || 0), 0);
    }

    function saveDayProgress(dayIndex, dayData) {
    gameProgress[dayIndex] = dayData;
    console.log(`üíæ Dati giorno ${dayIndex + 1} aggiornati:`, dayData);
    
    saveProgressToStorage(); // ‚≠ê AGGIUNGERE QUESTA RIGA ‚≠ê
  }


    // Dati delle costellazioni con informazioni dettagliate (aggiornati con dati reali)
    const CONSTELLATIONS = [
      {
        name: "Orsa Maggiore",
        options: ["Orsa Maggiore", "Orsa Minore", "Cassiopea", "Andromeda"],
        description: "Una delle costellazioni pi√π famose del cielo settentrionale, facilmente riconoscibile per la sua forma caratteristica a 'Grande Carro'.",
        hints: [
          "√à conosciuta anche come 'Grande Carro'",
          "Contiene sette stelle principali molto luminose", 
          "Le sue stelle puntano verso la Stella Polare"
        ]
      },
      {
        name: "Cassiopea",
        options: ["Cassiopea", "Andromeda", "Perseo", "Cigno"],
        description: "Riconoscibile per la sua forma a 'W' o 'M', √® una costellazione circumpolare facilmente visibile tutto l'anno.",
        hints: [
          "Ha la forma di una 'W' o di una 'M'",
          "√à circumpolare, sempre visibile alle nostre latitudini",
          "Prende il nome da una regina della mitologia greca"
        ]
      },
      {
        name: "Orione",
        options: ["Orione", "Scorpione", "Leone", "Sagittario"],
        description: "La costellazione del cacciatore, una delle pi√π spettacolari del cielo invernale, con la famosa Nebulosa di Orione.",
        hints: [
          "√à la costellazione del cacciatore nella mitologia",
          "Contiene la famosa cintura di tre stelle",
          "√à visibile principalmente in inverno"
        ]
      },
      {
        name: "Andromeda",
        options: ["Andromeda", "Cassiopea", "Perseo", "Pegaso"],
        description: "Costellazione che contiene la famosa Galassia di Andromeda, visibile a occhio nudo in cieli bui.",
        hints: [
          "Contiene la galassia pi√π vicina alla Via Lattea",
          "√à collegata al mito di Perseo e della principessa",
          "La sua galassia √® visibile a occhio nudo"
        ]
      },
      {
        name: "Perseo",
        options: ["Perseo", "Andromeda", "Cassiopea", "Auriga"],
        description: "Costellazione che rappresenta l'eroe della mitologia greca che salv√≤ Andromeda.",
        hints: [
          "√à l'eroe che salv√≤ Andromeda nella mitologia",
          "Contiene l'ammasso stellare delle Pleiadi nelle vicinanze",
          "√à visibile in autunno e inverno"
        ]
      },
      {
        name: "Cigno",
        options: ["Cigno", "Aquila", "Lira", "Drago"],
        description: "Una grande costellazione estiva, facilmente riconoscibile per la sua forma a croce.",
        hints: [
          "Ha la forma di una grande croce nel cielo",
          "√à una delle costellazioni pi√π grandi",
          "Contiene la stella Deneb, una delle pi√π luminose"
        ]
      },
      {
        name: "Aquila",
        options: ["Aquila", "Cigno", "Lira", "Freccia"],
        description: "Costellazione che rappresenta l'aquila di Zeus nella mitologia greca.",
        hints: [
          "Rappresenta l'aquila di Zeus",
          "Contiene la stella brillante Altair",
          "√à parte del triangolo estivo"
        ]
      },
      {
        name: "Lira",
        options: ["Lira", "Cigno", "Aquila", "Ercole"],
        description: "Piccola costellazione che contiene Vega, una delle stelle pi√π brillanti del cielo.",
        hints: [
          "Contiene Vega, stella molto brillante",
          "Rappresenta lo strumento musicale di Orfeo",
          "√à piccola ma molto riconoscibile"
        ]
      },
      {
        name: "Drago",
        options: ["Drago", "Orsa Minore", "Cefeo", "Giraffa"],
        description: "Una grande costellazione circumpolare che si avvolge attorno al polo nord celeste.",
        hints: [
          "Si avvolge attorno al polo nord celeste",
          "√à una costellazione molto estesa",
          "√à sempre visibile alle nostre latitudini"
        ]
      },
      {
        name: "Boote",
        options: ["Boote", "Vergine", "Corona Boreale", "Ercole"],
        description: "Costellazione primaverile che contiene Arturo, una delle stelle pi√π brillanti.",
        hints: [
          "Contiene Arturo, stella molto brillante",
          "√à chiamato anche il Pastore",
          "√à ben visibile in primavera"
        ]
      }
    ];
    
    // Generiamo 31 costellazioni utilizzando quelle base
    const FULL_CONSTELLATIONS = Array.from({ length: 31 }, (_, i) => {
      const base = CONSTELLATIONS[i % CONSTELLATIONS.length];
      return {
        ...base,
        name: i < CONSTELLATIONS.length ? base.name : `${base.name} ${Math.floor(i / CONSTELLATIONS.length) + 1}`,
        description: i < CONSTELLATIONS.length ? base.description : `${base.description} (Variazione ${Math.floor(i / CONSTELLATIONS.length) + 1})`
      };
    });









    // Utility functions
    function shuffleArray(array) {
      const shuffled = [...array]; 
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    function generateBackupCode(data) {
      const jsonString = JSON.stringify(data);
      return btoa(encodeURIComponent(jsonString));
    }

    function parseBackupCode(code) {
      try {
        const jsonString = decodeURIComponent(atob(code));
        return JSON.parse(jsonString);
      } catch (error) {
        throw new Error('Codice di backup non valido');
      }
    }

    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = 'toast';
      
      const colors = {
        success: '#4ade80',
        error: '#f87171',
        warning: '#facc15',
        info: '#60a5fa'
      };
      
      toast.style.borderLeft = `4px solid ${colors[type]}`;
      toast.textContent = message;
      
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }





    // App semplificata - inizializzazione diretta

    // Componente principale semplificato
    function App() {
      const [initialized, setInitialized] = useState(false);
      
      const today = new Date();
      const currentDay = today.getDate();
      const currentMonth = today.getMonth(); // 0-based (dicembre = 11)
      const currentYear = today.getFullYear();
      
      // LOGICA CORRETTA PER TESTING - 17 ottobre 2025
      let maxDay;
      
      console.log("üìÖ Data corrente:", today);
      console.log("üìÖ Mese corrente:", currentMonth, "(0=gen, 9=ott, 11=dic)");
      console.log("üìÖ Giorno corrente:", currentDay);
      
      if (currentMonth === 11 && currentYear === 2025) { 
        // Se siamo a dicembre 2025, sblocca fino al giorno corrente
        maxDay = currentDay;
        console.log("üóìÔ∏è Modalit√† dicembre: giorni sbloccati fino al", maxDay);
      } else if (currentMonth < 11 || currentYear < 2025) { 
        // Se siamo PRIMA di dicembre (come ora ottobre), sblocca i primi 5 giorni per TESTING
        maxDay = 5; // FISSO per testing
        console.log("üß™ Modalit√† testing PRE-dicembre: giorni sbloccati:", maxDay);
      } else { 
        // Se siamo DOPO dicembre, sblocca tutto
        maxDay = 31;
        console.log("üéâ Modalit√† post-dicembre: tutti i giorni sbloccati");
      }
      
      console.log("‚úÖ Giorni max disponibili:", maxDay);
      
      // FALLBACK DI EMERGENZA come richiesto
      if (typeof maxDay !== 'number' || isNaN(maxDay) || maxDay < 0) {
        console.warn("‚ö†Ô∏è FALLBACK ATTIVATO: Logica date fallita, forzando 5 giorni per testing");
        maxDay = 5;
      }
      
      const [progress, setProgress] = useState(gameProgress);

      useEffect(() => {
        gameProgress = { ...progress };
        saveProgressToStorage();
      }, [progress]);
      
      const [activeModal, setActiveModal] = useState(null);
      const [settingsModal, setSettingsModal] = useState(false);
      const [initError, setInitError] = useState(null);
      
      // Gestione apertura settings da pulsante esterno
      useEffect(() => {
        const handleOpenSettings = () => setSettingsModal(true);
        window.addEventListener('openSettings', handleOpenSettings);
        return () => window.removeEventListener('openSettings', handleOpenSettings);
      }, []);
      

      const [feedback, setFeedback] = useState("");
      
      // BUG FIX #2: Traccia TUTTE le risposte sbagliate per ogni giorno
      const [wrongAnswers, setWrongAnswers] = useState({});
      
      const [totalScore, setTotalScore] = useState(0);
      const [stats, setStats] = useState({});
      
      // BUG FIX #1: Stato per opzioni mescolate una sola volta per modal
      const [shuffledOptions, setShuffledOptions] = useState({});
      
      // BUG FIX #1: Traccia TUTTI i tentativi (non solo errori)
      const [totalAttempts, setTotalAttempts] = useState({});

      // INIZIALIZZAZIONE SEMPLIFICATA
      useEffect(() => {
        console.log('üöÄ Inizializzando calendario semplificato...');
        
        try {
          // Carica progresso dalla memoria JavaScript
          const savedProgress = loadProgress();
          console.log('‚úÖ Progresso caricato dalla memoria:', Object.keys(savedProgress).length, 'giorni');
          
          setProgress(savedProgress);
          setInitialized(true);
          
          if (Object.keys(savedProgress).length > 0) {
            showToast('üíæ Progressi in memoria trovati!', 'success');
          }
          
        } catch (error) {
          console.error('‚ùå Errore inizializzazione:', error);
          setProgress({});
          setInitialized(true);
        }
      }, []);

      // SALVATAGGIO AUTOMATICO IN MEMORIA
      useEffect(() => {
        if (!initialized) return;
        
        // Aggiorna lo stato globale in memoria
        gameProgress = { ...progress };
        console.log('üíæ Progresso aggiornato in memoria JavaScript');
      }, [progress, initialized]);

      // Calcolo statistiche semplificato
      useEffect(() => {
        let score = 0;
        let completed = 0;
        
        Object.entries(progress).forEach(([dayIndex, entry]) => {
          const entryScore = entry.finalScore !== undefined ? entry.finalScore : (entry.score || 0);
          score += entryScore;
          
          if (entry.solved) completed++;
        });
        
        setTotalScore(score);
        
        console.log('üìà Statistiche aggiornate:', {
          punteggio: score,
          completati: completed
        });
      }, [progress]);

      // Aggiornamento UI semplificato
      useEffect(() => {
        const totalScoreEl = document.getElementById("totalScore");
        
        if (totalScoreEl) {
          totalScoreEl.innerText = `‚≠ê Punteggio Totale: ${totalScore}`;
        }
      }, [totalScore]);

      // BUG FIX #1 & #2: LOGICA RISPOSTA CORRETTA
      function handleAnswer(index, choice) {
        const correct = FULL_CONSTELLATIONS[index].name;
        
        setProgress(prev => {
          const entry = prev[index] || { attempts: 0, solved: false, score: 3, usedHints: 0 };
          if (entry.solved) return prev;
          
          // BUG FIX #1: INCREMENTA SEMPRE totalAttempts
          setTotalAttempts(prevAttempts => ({
            ...prevAttempts,
            [index]: (prevAttempts[index] || 0) + 1
          }));
          
          if (choice === correct) {
            // Risposta corretta
            entry.solved = true;
            entry.attempts = (totalAttempts[index] || 0) + 1; // BUG FIX #1: Salva conteggio corretto
            entry.finalScore = entry.score;
            entry.completedAt = new Date().toISOString();
            
            console.log(`‚úÖ RISPOSTA CORRETTA Giorno ${index + 1}:`, {
              tentativi_totali: entry.attempts,
              punteggio_finale: entry.score
            });
            
            setFeedback("‚úÖ Corretto! Ottimo lavoro!");
            
            // BUG FIX #2: Pulisci risposte sbagliate per questo giorno
            setWrongAnswers(prev => ({ ...prev, [index]: [] }));
            
            const scoreText = entry.score >= 0 ? `+${entry.score}` : `${entry.score}`;
            showToast(`üéÜ Giorno ${index + 1} completato! ${scoreText} punti`, 'success');
            
          } else {
            // Risposta sbagliata
            entry.score = entry.score - 1;
            
            // BUG FIX #2: Aggiungi alla lista delle risposte sbagliate
            setWrongAnswers(prev => ({
              ...prev,
              [index]: [...(prev[index] || []), choice]
            }));
            
            console.log(`‚ùå RISPOSTA SBAGLIATA Giorno ${index + 1}:`, {
              risposta_data: choice,
              risposta_corretta: correct,
              punti_rimasti: entry.score,
              tentativi_attuali: (totalAttempts[index] || 0) + 1
            });
            
            const scoreDisplay = entry.score >= 0 ? `+${entry.score}` : `${entry.score}`;
            setFeedback(`‚ùå Risposta sbagliata! Punti rimasti: ${scoreDisplay}`);
          }
          
          return { ...prev, [index]: entry };
        });
      }

      // LOGICA INDIZI SEMPLIFICATA
      function useHint(index) {
        setProgress(prev => {
          const entry = prev[index] || { attempts: 0, solved: false, score: 3, usedHints: 0 };
          if (entry.solved || entry.usedHints >= 3) return prev;
          
          entry.score = entry.score - 1;
          entry.usedHints += 1;
          
          const hint = FULL_CONSTELLATIONS[index].hints[entry.usedHints - 1];
          const scoreDisplay = entry.score >= 0 ? `+${entry.score}` : `${entry.score}`;
          setFeedback(`üí° Indizio: ${hint} (Punti rimasti: ${scoreDisplay})`);
          
          return { ...prev, [index]: entry };
        });
      }





      // Loading screen semplificato
      if (!initialized) {
        return React.createElement('div', { className: 'text-center py-20' }, 
          React.createElement('div', { className: 'text-2xl mb-4' }, '‚≠ê Caricamento calendario...'),
          React.createElement('div', { className: 'text-lg text-gray-300 mt-2' }, 'Preparazione costellazioni...')
        );
      }
      
      console.log('‚úÖ App completamente caricata, rendering calendario con maxDay:', maxDay);

      return React.createElement(
        React.Fragment,
        null,
        
        // Banner informativo semplificato
        React.createElement(
          "div",
          { className: "info-banner mb-4 p-4 bg-gradient-to-r from-blue-900 to-green-900 bg-opacity-70 rounded-xl border-2 border-blue-400 border-opacity-50" },
          React.createElement("div", { className: "flex items-center gap-3 text-blue-100" },
            React.createElement("span", { className: "text-2xl" }, "üí°"),
            React.createElement("div", { className: "flex-1" },
              React.createElement("p", { className: "text-base font-semibold mb-1" }, 
                "I tuoi progressi vengono salvati automaticamente in questa sessione."
              ),
              React.createElement("p", { className: "text-sm opacity-90" }, 
                "I progressi sono salvati in memoria durante questa sessione. Sistema semplificato senza login."
              )
            )
          )
        ),
        
        // Messaggio di stato del calendario
        React.createElement(
          "div",
          { className: "mb-6 p-4 bg-blue-900 bg-opacity-50 rounded-xl border border-blue-400" },
          React.createElement("h3", { className: "text-lg font-bold text-blue-200 mb-2" }, "üèÜ Stato del Calendario"),
          React.createElement("p", { className: "text-blue-100" }, 
            maxDay > 0 
              ? `‚ú® Hai accesso ai primi ${maxDay} giorni! Clicca su un giorno per iniziare la sfida.`
              : "üîí Tutti i giorni sono ancora bloccati. Torna a dicembre per iniziare!"
          ),
          React.createElement("p", { className: "text-blue-200 text-sm mt-1" }, 
            `üìÖ Data corrente: ${today.toLocaleDateString('it-IT')} | Modalit√†: ${currentMonth < 11 ? 'Testing Pre-Dicembre' : currentMonth === 11 ? 'Dicembre Ufficiale' : 'Post-Dicembre'}`
          )
        ),
        
        // Griglia giorni con layout migliorato
        React.createElement(
          "div",
          { 
            id: "calendarGrid",
            className: "w-full"
          },
          FULL_CONSTELLATIONS.map((c, i) => {
            const index = i + 1;
            const entry = progress[i] || { attempts: 0, solved: false, score: 3, usedHints: 0 };
            const locked = index > maxDay;
            
            // Debug per ogni giorno
            if (i < 10) { // Solo primi 10 giorni per evitare spam
              console.log(`Giorno ${index}: ${locked ? 'BLOCCATO' : 'SBLOCCATO'} (maxDay=${maxDay})`);
            }

            function openModal() {
              if (!locked) {
                setActiveModal(i);
                setFeedback("");
                
                // BUG FIX #1: Mescola opzioni UNA VOLTA all'apertura del modal
                if (!shuffledOptions[i]) {
                  const mixed = shuffleArray([...FULL_CONSTELLATIONS[i].options]);
                  setShuffledOptions(prev => ({ ...prev, [i]: mixed }));
                  console.log(`üé≤ Opzioni mescolate per giorno ${i + 1}:`, mixed);
                }
              }
            }

            return React.createElement(
              "div",
              {
                key: i,
                className: `calendar-day ${locked ? 'locked' : entry.solved ? 'completed' : 'available'}`,
                onClick: openModal,
                'data-day': index
              },
              React.createElement("h2", null, `Giorno ${index}`),
              React.createElement("div", { className: "day-icon" }, 
                locked ? "üîí" : entry.solved ? "üéÜ" : "‚ú®"
              ),
              React.createElement("div", { className: "day-status" },
                locked 
                  ? `Bloccato fino al ${index} dicembre`
                  : entry.solved 
                    ? (() => {
                        const finalScore = entry.finalScore !== undefined ? entry.finalScore : entry.score;
                        const displayScore = finalScore >= 0 ? `+${finalScore}` : `${finalScore}`;
                        return `Completato! ‚≠ê ${displayScore}`;
                      })()
                    : "üîπ Clicca per iniziare!"
              )
            );
          })
        ),
        
        // Modal gioco
        activeModal !== null && React.createElement(
          "div",
          { className: "full-screen-modal" },
          React.createElement("button", { className: "close-button", onClick: () => setActiveModal(null) }, "√ó"),
          React.createElement("div", { className: "modal-content" },
            React.createElement("h2", { className: "text-3xl font-bold mb-4" }, `‚ú® Giorno ${activeModal + 1}`),
            React.createElement("div", { className: "mb-4 text-center" },
              React.createElement("div", { 
                className: "w-64 h-64 mx-auto bg-gradient-to-br from-blue-900 via-purple-900 to-indigo-900 rounded-lg flex flex-col items-center justify-center text-white border-2 border-yellow-400 shadow-lg",
                style: { backgroundImage: 'radial-gradient(circle at 30% 30%, rgba(255,255,255,0.1) 1px, transparent 1px), radial-gradient(circle at 70% 70%, rgba(255,255,255,0.08) 1px, transparent 1px)' }
              },
                React.createElement("div", { className: "text-6xl mb-2" }, "‚ú®"),
                React.createElement("div", { className: "text-lg font-bold" }, FULL_CONSTELLATIONS[activeModal].name),
                React.createElement("div", { className: "text-sm text-gray-300 mt-2 px-4 text-center" }, "Osserva attentamente le stelle di questa costellazione")
              )
            ),
            !progress[activeModal]?.solved && React.createElement(React.Fragment, null,
              React.createElement("p", { className: "mb-4 text-lg" }, "Quale costellazione √® questa?"),
              React.createElement("div", { className: "flex flex-col gap-3" },
                // BUG FIX #1 & #2: Opzioni mescolate con risposte multiple sbagliate
                (shuffledOptions[activeModal] || FULL_CONSTELLATIONS[activeModal].options).map((opt, j) => {
                  const dayWrongAnswers = wrongAnswers[activeModal] || [];
                  const isWrong = dayWrongAnswers.includes(opt);
                  const isCorrect = progress[activeModal]?.solved && opt === FULL_CONSTELLATIONS[activeModal].name;
                  
                  return React.createElement("button", {
                    key: j,
                    onClick: () => handleAnswer(activeModal, opt),
                    disabled: progress[activeModal]?.solved || isWrong,
                    className: `option-button px-4 py-2 rounded-lg shadow transition-all ${
                      isCorrect ? 'bg-green-600 hover:bg-green-700 text-white' : 
                      isWrong ? 'bg-red-600 text-white cursor-not-allowed opacity-75' : 
                      'bg-blue-600 hover:bg-blue-700 text-white'
                    }`
                  }, opt);
                })
              ),
              feedback && React.createElement("div", { className: `feedback ${feedback.includes('Corretto') ? 'correct' : feedback.includes('sbagliata') ? 'wrong' : ''}` }, feedback),
              // BUG FIX #2: DISPLAY CORRETTO DEI PUNTI
              React.createElement("div", { className: "mt-4 p-3 bg-gray-800 rounded-lg text-center" },
                React.createElement("div", { className: "text-lg font-bold text-yellow-300" }, 
                  (() => {
                    const currentScore = progress[activeModal]?.score ?? 3;
                    const displayScore = currentScore >= 0 ? `+${currentScore}` : `${currentScore}`;  // BUG FIX: NO +-2 ma -2
                    return `‚≠ê Punti attuali: ${displayScore}`;
                  })()
                ),
                React.createElement("div", { className: "text-sm text-gray-400 mt-1" }, 
                  (() => {
                    const currentScore = progress[activeModal]?.score ?? 3;
                    const hints = progress[activeModal]?.usedHints || 0;
                    const errors = Math.max(0, (progress[activeModal]?.attempts || 0) - (progress[activeModal]?.solved ? 1 : 0));
                    return `Formula: 3 - ${hints} indizi - ${errors} errori = ${currentScore}`;
                  })()
                ),
                progress[activeModal]?.score < 0 && React.createElement("div", { className: "text-sm text-red-400 font-bold mt-1" }, 
                  "‚ö†Ô∏è Attenzione: sei in punteggio negativo!"
                )
              ),
              React.createElement("div", { className: "mt-4 flex justify-between items-center" },
                React.createElement("button", { 
                  onClick: () => useHint(activeModal), 
                  className: "text-sm text-yellow-400 underline hover:text-yellow-300",
                  disabled: (progress[activeModal]?.usedHints || 0) >= 3
                }, `üí° Usa indizio (${progress[activeModal]?.usedHints || 0}/3)`),
                React.createElement("p", { className: "text-sm" }, 
                  (() => {
                    const currentScore = progress[activeModal]?.score ?? 3;
                    const displayScore = currentScore >= 0 ? `+${currentScore}` : `${currentScore}`;  // BUG FIX #2
                    return `‚≠ê Punti: ${displayScore}`;
                  })()
                )
              )
            ),
            progress[activeModal]?.solved && React.createElement("div", { className: "mt-6 text-lg space-y-4" },
              React.createElement("h3", { className: "text-xl font-bold text-yellow-400" }, FULL_CONSTELLATIONS[activeModal].name),
              React.createElement("p", { className: "text-gray-300" }, FULL_CONSTELLATIONS[activeModal].description),
              React.createElement("div", { className: "bg-gray-800 p-4 rounded-lg" },
                React.createElement("h4", { className: "font-semibold mb-2" }, "üìä Statistiche:"),
                React.createElement("p", { className: "text-sm text-gray-300" }, `‚ùå Tentativi sbagliati: ${(progress[activeModal]?.attempts || 1) - 1}`),
                React.createElement("p", { className: "text-sm text-gray-300" }, `üí° Indizi usati: ${progress[activeModal]?.usedHints || 0}`),
                React.createElement("p", { className: "text-sm text-yellow-300 font-semibold" }, `‚≠ê Punteggio ottenuto: ${progress[activeModal]?.score || 0}`)
              )
            )
          )
        ),
        
        // Modal impostazioni
        settingsModal && React.createElement(
          "div",
          { className: "full-screen-modal" },
          React.createElement("button", { className: "close-button", onClick: () => setSettingsModal(false) }, "√ó"),
          React.createElement("div", { className: "modal-content max-w-2xl" },
            React.createElement("h2", { className: "text-3xl font-bold mb-6" }, "‚öôÔ∏è Impostazioni"),
            
            // Sezione utente
            React.createElement("div", { className: "backup-section" },
              React.createElement("h3", { className: "text-xl font-semibold mb-4" }, "üë§ Profilo Utente"),
              React.createElement("div", { className: "space-y-3" },
                React.createElement("div", { className: "text-center" },
                  React.createElement("div", { className: "text-lg font-semibold text-white mb-2" }, `üë§ ${USERS[username]?.displayName || username}`),
                  React.createElement("p", { className: "text-sm text-gray-400" }, 
                    "Il tuo nome utente e display name sono gestiti dal sistema di login."
                  )
                )
              )
            ),
            
            // Statistiche
            React.createElement("div", { className: "backup-section" },
              React.createElement("h3", { className: "text-xl font-semibold mb-4" }, "üìä Statistiche"),
              React.createElement("div", { className: "stats-grid" },
                React.createElement("div", { className: "stat-card" },
                  React.createElement("div", { className: "text-2xl font-bold text-yellow-400" }, stats.totalScore || 0),
                  React.createElement("div", { className: "text-sm text-gray-400" }, "Punti Totali")
                ),
                React.createElement("div", { className: "stat-card" },
                  React.createElement("div", { className: "text-2xl font-bold text-green-400" }, stats.completedDays || 0),
                  React.createElement("div", { className: "text-sm text-gray-400" }, "Giorni Completati")
                ),
                React.createElement("div", { className: "stat-card" },
                  React.createElement("div", { className: "text-2xl font-bold text-blue-400" }, stats.totalAttempts || 0),
                  React.createElement("div", { className: "text-sm text-gray-400" }, "Tentativi Totali")
                ),
                React.createElement("div", { className: "stat-card" },
                  React.createElement("div", { className: "text-2xl font-bold text-purple-400" }, stats.totalHints || 0),
                  React.createElement("div", { className: "text-sm text-gray-400" }, "Indizi Usati")
                )
              )
            ),
            
            // Backup e ripristino
            React.createElement("div", { className: "backup-section" },
              React.createElement("h3", { className: "text-xl font-semibold mb-4" }, "üíæ Backup &amp; Ripristino"),
              React.createElement("p", { className: "text-sm text-gray-400 mb-4" }, 
                "Usa queste funzioni per salvare o ripristinare il tuo progresso su altri dispositivi. I codici di backup sono sicuri e contengono tutti i tuoi dati."
              ),
              React.createElement("div", { className: "space-y-4" },
                React.createElement("div", null,
                  React.createElement("button", {
                    onClick: exportUserProgress,
                    className: "w-full px-4 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors mb-2"
                  }, "üì§ Genera Codice di Backup"),
                  React.createElement("p", { className: "text-sm text-gray-400" }, "Copia il codice per salvare il tuo progresso")
                ),
                React.createElement("div", null,
                  React.createElement("input", {
                    id: "import-input",
                    type: "text",
                    placeholder: "Incolla qui il codice di backup",
                    className: "w-full px-3 py-2 bg-gray-700 rounded border border-gray-600 text-white mb-2"
                  }),
                  React.createElement("button", {
                    onClick: () => {
                      const code = document.getElementById('import-input').value;
                      if (code) importUserProgress(code);
                    },
                    className: "w-full px-4 py-3 bg-green-600 hover:bg-green-700 rounded-lg transition-colors"
                  }, "üì• Importa Progresso")
                ),
                React.createElement("div", null,
                  React.createElement("button", {
                    onClick: resetUserProgress,
                    className: "w-full px-4 py-3 bg-red-600 hover:bg-red-700 rounded-lg transition-colors"
                  }, "üóëÔ∏è Reset Completo"),
                  React.createElement("p", { className: "text-sm text-gray-400 mt-1" }, "‚ö†Ô∏è Questa azione canceller√† tutto il progresso in modo permanente")
                )
              )
            ),
            
            // Info tecnica
            React.createElement("div", { className: "backup-section" },
              React.createElement("h3", { className: "text-xl font-semibold mb-4" }, "‚ÑπÔ∏è Informazioni"),
              React.createElement("div", { className: "text-sm text-gray-400 space-y-2" },
                React.createElement("p", null, `üóÑÔ∏è Salvataggio: ${dataManager.fallbackToMemory ? 'Memoria Temporanea' : 'IndexedDB (Persistente)'}`),
                React.createElement("p", null, `üìÖ Ultima sincronizzazione: ${new Date().toLocaleString('it-IT')}`),
                React.createElement("p", null, `üì± Versione: 2.0 - Calendario Costellazioni`),
                React.createElement("p", null, `üåü Giorni disponibili: ${maxDay}/31`)
              )
            )
          )
        )
      );
    }



    // ========================================
    // MODAL EXPORT MIGLIORATO E USER-FRIENDLY
    // ========================================
    
    function exportProgress() {
      try {
        updateSaveIndicator('saving');
        
        const code = exportProgressCode();
        const finalCode = `ADVENT_V2_${code}`;
        
        showExportModal(finalCode);
        
        console.log('üì§ Export completato, modal mostrato');
        return finalCode;
        
      } catch (error) {
        console.error('‚ùå Errore esportazione:', error);
        showToast('Errore durante l\'esportazione', 'error');
        updateSaveIndicator('error');
      }
    }

    // ========================================
    // MODAL IMPORT MIGLIORATO CON VALIDAZIONE
    // ========================================
    
    function importProgress() {
      showImportModal();
    }
    
    function executeImport() {
      const code = document.getElementById('importCode').value.trim();
      const feedback = document.getElementById('importFeedback');
      
      if (!code) {
        showImportFeedback('‚ùå Inserisci un codice valido', 'error');
        return;
      }
      
      updateSaveIndicator('saving');
      showImportFeedback('üîÑ Importazione in corso...', 'info');
      
      // Pulizia codice
      const cleanCode = code.replace(/ADVENT_V2_|ADVENT_/g, '');
      
      const result = importProgressCode(cleanCode);
      
      if (result.success) {
        showImportFeedback(`‚úÖ Dati importati con successo! (${result.usersImported} utenti)`, 'success');
        
        // Auto-chiudi e aggiorna dopo successo
        setTimeout(() => {
          closeImportModal();
          autoSave();
          
          // Se l'utente corrente √® stato aggiornato, ricarica interfaccia
          if (currentUser) {
            window.dispatchEvent(new CustomEvent('dataImported'));
            location.reload();
          }
        }, 1500);
        
      } else {
        showImportFeedback(`‚ùå Errore: ${result.error}`, 'error');
        updateSaveIndicator('error');
      }
    }
    
    function showImportFeedback(message, type) {
      const feedback = document.getElementById('importFeedback');
      if (feedback) {
        feedback.innerHTML = message;
        feedback.className = `import-feedback ${type}`;
      }
    }

    // ========================================
    // MODAL EXPORT CON ISTRUZIONI CHIARE
    // ========================================
    function showExportModal(code) {
      const modal = document.createElement('div');
      modal.className = 'backup-modal';
      modal.innerHTML = `
        <div class="backup-content">
          <h2>üì§ Esporta Progressi</h2>
          <p class="backup-instructions">
            <strong>Copia questo codice e salvalo in un posto sicuro:</strong><br>
            Potrai usarlo per ripristinare i progressi su altri browser o dispositivi.
          </p>
          <textarea readonly id="exportCode" class="backup-code">${code}</textarea>
          <div class="backup-actions">
            <button onclick="copyBackupCode()" class="btn btn--primary">üìã Copia Codice</button>
            <button onclick="closeBackupModal()" class="btn btn--secondary">Chiudi</button>
          </div>
          <p class="backup-note">üí° <strong>Dove salvarlo:</strong> WhatsApp a te stesso, email, note del telefono, cloud drive</p>
          <div class="backup-info">
            <small>üîí Codice sicuro ‚Ä¢ ‚è∞ ${new Date().toLocaleString('it-IT')} ‚Ä¢ üë• ${Object.keys(window.ADVENT_DATA.users).length} utenti</small>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Auto-select text per facile copia
      const textarea = document.getElementById('exportCode');
      if (textarea) {
        textarea.select();
        textarea.focus();
      }
    }
    
    function showImportModal() {
      const modal = document.createElement('div');
      modal.className = 'backup-modal';
      modal.innerHTML = `
        <div class="backup-content">
          <h2>üì• Importa Progressi</h2>
          <p class="backup-instructions">
            <strong>Incolla qui il codice di backup</strong> per ripristinare i progressi:
          </p>
          <textarea id="importCode" class="backup-code" placeholder="Incolla il codice qui...\n\nPuoi incollare codici che iniziano con:\n‚Ä¢ ADVENT_V2_...\n‚Ä¢ ADVENT_...\n‚Ä¢ Oppure il codice diretto"></textarea>
          <div id="importFeedback" class="import-feedback"></div>
          <div class="backup-actions">
            <button onclick="executeImport()" class="btn btn--primary">‚úÖ Importa Dati</button>
            <button onclick="closeBackupModal()" class="btn btn--secondary">Annulla</button>
          </div>
          <p class="backup-note">‚ö†Ô∏è I dati attuali verranno <strong>uniti</strong> con quelli importati (mantiene il punteggio migliore per ogni giorno)</p>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Focus sul campo di input
      const textarea = document.getElementById('importCode');
      if (textarea) {
        textarea.focus();
        
        // Auto-import al paste
        textarea.addEventListener('paste', () => {
          setTimeout(() => {
            if (textarea.value.trim()) {
              showImportFeedback('üìã Codice incollato! Clicca "Importa Dati" per continuare.', 'info');
            }
          }, 100);
        });
      }
    }

    // ========================================
    // GESTIONE MODALS UNIFICATA
    // ========================================
    function closeBackupModal() {
      const modals = document.querySelectorAll('.backup-modal, .export-modal');
      modals.forEach(modal => {
        modal.style.animation = 'fadeOut 0.3s ease-out';
        setTimeout(() => modal.remove(), 300);
      });
    }
    
    function closeExportModal() {
      closeBackupModal();
    }
    
    function closeImportModal() {
      closeBackupModal();
    }
    
    // Click outside to close
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('backup-modal')) {
        closeBackupModal();
      }
    });
    
    // Escape key to close
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeBackupModal();
      }
    });

    // ========================================
    // COPIA NEGLI APPUNTI CON FEEDBACK MIGLIORATO
    // ========================================
    function copyBackupCode() {
      const textarea = document.getElementById('exportCode');
      if (!textarea) return;
      
      const code = textarea.value;
      
      if (navigator.clipboard) {
        navigator.clipboard.writeText(code).then(() => {
          showToast('üìã Codice copiato negli appunti!', 'success');
          
          // Cambio temporaneo del bottone
          const btn = event.target;
          const originalText = btn.innerHTML;
          btn.innerHTML = '‚úÖ Copiato!';
          btn.style.background = '#10b981';
          
          setTimeout(() => {
            btn.innerHTML = originalText;
            btn.style.background = '';
          }, 2000);
          
        }).catch(() => {
          fallbackCopyToClipboard(code);
        });
      } else {
        fallbackCopyToClipboard(code);
      }
    }
    
    function copyToClipboard(text) {
      copyBackupCode();
    }

    function fallbackCopyToClipboard(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.top = '0';
      textArea.style.left = '0';
      textArea.style.width = '2em';
      textArea.style.height = '2em';
      textArea.style.padding = '0';
      textArea.style.border = 'none';
      textArea.style.outline = 'none';
      textArea.style.boxShadow = 'none';
      textArea.style.background = 'transparent';
      document.body.appendChild(textArea);
      textArea.select();
      
      try {
        const successful = document.execCommand('copy');
        if (successful) {
          alert('‚úÖ Codice copiato negli appunti!');
        } else {
          alert('‚ùå Impossibile copiare automaticamente. Seleziona e copia manualmente.');
        }
      } catch (err) {
        alert('‚ùå Impossibile copiare automaticamente. Seleziona e copia manualmente.');
      }
      
      document.body.removeChild(textArea);
      closeExportModal();
    }

    // ========================================
    // CLASSIFICA CON MEMORIA PURA
    // ========================================
    function showLeaderboard() {
      if (!currentUser) {
        console.error('‚ùå Nessun utente loggato per la classifica');
        return;
      }
      
      console.log('=== CARICAMENTO CLASSIFICA DA MEMORIA ===');
      console.log('üë§ Utente corrente:', currentUser);
      
      try {
        // Ottieni classifica dalla memoria
        const leaderboardData = getLeaderboard();
        console.log('üìä Risultati classifica da memoria:', leaderboardData);
        
        // Crea modal classifica
        const modal = document.createElement('div');
        modal.className = 'full-screen-modal';
        
        console.log('üé® Creazione modal con dati finali:', leaderboardData);
        
        const content = leaderboardData.length === 0 ? 
          `<div style="text-align: center; padding: 2rem;">
            <h3 style="color: #888; margin-bottom: 1rem;">ü§∑‚Äç‚ôÇÔ∏è Nessun dato disponibile</h3>
            <p style="color: #666; font-size: 0.9rem;">Completa almeno un giorno per apparire in classifica!</p>
            <div style="margin-top: 1rem; font-size: 0.8rem; color: #555; font-family: monospace;">
              <p>Debug: Utente = ${currentUser}</p>
              <p>Modalit√†: Memoria JavaScript pura</p>
              <p>Utenti nella memoria: ${Object.keys(window.ADVENT_DATA.users).join(', ')}</p>
              <p>Progressi trovati: ${Object.keys(window.ADVENT_DATA.users).map(u => Object.keys(window.ADVENT_DATA.users[u].progress).length).join(', ')}</p>
            </div>
          </div>` :
          leaderboardData.map((user, index) => {
            const isCurrentUser = user.username === currentUser;
            const scoreColor = user.score >= 0 ? '#FFD700' : '#FF6B6B';
            const scoreText = user.score >= 0 ? user.score : `${user.score} (negativo)`;
            
            return `
              <div class="leaderboard-row ${isCurrentUser ? 'current-user' : ''}">
                <div style="display: flex; align-items: center; gap: 1rem;">
                  <div class="rank-badge ${index === 0 ? 'first' : index === 1 ? 'second' : index === 2 ? 'third' : ''}">
                    ${index + 1}
                  </div>
                  <div>
                    <div style="font-weight: bold; color: white;">
                      ${user.name} ${isCurrentUser ? '(Tu)' : ''}
                    </div>
                    <div style="font-size: 0.9rem; color: #ccc;">
                      ${user.days}/31 giorni completati
                    </div>
                  </div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 1.5rem; font-weight: bold; color: ${scoreColor};">
                    ‚≠ê ${scoreText}
                  </div>
                </div>
              </div>
            `;
          }).join('');
        
        modal.innerHTML = `
          <button class="close-button" onclick="this.parentElement.remove()">√ó</button>
          <div class="leaderboard">
            <h2 class="leaderboard-title">üèÜ Classifica Generale</h2>
            <div style="margin-bottom: 1rem; text-align: center; font-size: 0.9rem; color: #999;">
              Aggiornata: ${new Date().toLocaleTimeString('it-IT')}
            </div>
            <div style="margin-bottom: 1rem; text-align: center; font-size: 0.8rem; color: #666; background: rgba(255,215,0,0.1); padding: 0.5rem; border-radius: 0.5rem;">
              ‚ö†Ô∏è Dati salvati solo in questa sessione. Usa 'Esporta' per backup permanente.
            </div>
            ${content}
          </div>
        `;
        
        document.body.appendChild(modal);
        console.log('‚úÖ Classifica mostrata con successo');
        
      } catch (error) {
        console.error('‚ùå Errore caricamento classifica:', error);
        showToast('Errore caricamento classifica', 'error');
      }
    }
    
    // Inizializzazione semplificata
    function initializeApp() {
      console.log('üöÄ Inizializzando Calendario dell\'Avvento semplificato...');
      
      // Carica progresso dalla memoria se presente
      const progress = loadProgress();
      if (Object.keys(progress).length > 0) {
        console.log('üíæ Progressi trovati in memoria JavaScript:', Object.keys(progress).length, 'giorni');
      }
    }

    // Inizializzazione DOM semplificata
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ DOM caricato, avvio calendario semplificato...');
      
      initializeApp();
      
      // Nascondi elementi non necessari e mostra app
      const mainApp = document.getElementById('mainApp');
      if (mainApp) {
        mainApp.style.display = 'block';
      }
      
      // Avvia app React direttamente
      try {
        const container = document.getElementById('app');
        if (container) {
          const root = ReactDOM.createRoot(container);
          root.render(React.createElement(App));
          console.log('‚úÖ App calendario inizializzata con successo');
          
          setTimeout(() => {
            showToast('üéÑ Calendario dell\'Avvento caricato! Buon divertimento!', 'success');
          }, 1000);
        }
      } catch (error) {
        console.error('‚ùå Errore inizializzazione app:', error);
        showToast('Errore caricamento calendario', 'error');
      }
    });
    

  </script>
</body>
</html>
