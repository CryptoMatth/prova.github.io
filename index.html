<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calendario dell'Avvento - Costellazioni</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      /* Primitive Color Tokens */
      --color-white: rgba(255, 255, 255, 1);
      --color-black: rgba(0, 0, 0, 1);
      --color-cream-50: rgba(252, 252, 249, 1);
      --color-cream-100: rgba(255, 255, 253, 1);
      --color-gray-200: rgba(245, 245, 245, 1);
      --color-gray-300: rgba(167, 169, 169, 1);
      --color-gray-400: rgba(119, 124, 124, 1);
      --color-slate-500: rgba(98, 108, 113, 1);
      --color-brown-600: rgba(94, 82, 64, 1);
      --color-charcoal-700: rgba(31, 33, 33, 1);
      --color-charcoal-800: rgba(38, 40, 40, 1);
      --color-slate-900: rgba(19, 52, 59, 1);
      --color-teal-300: rgba(50, 184, 198, 1);
      --color-teal-400: rgba(45, 166, 178, 1);
      --color-teal-500: rgba(33, 128, 141, 1);
      --color-teal-600: rgba(29, 116, 128, 1);
      --color-teal-700: rgba(26, 104, 115, 1);
      --color-teal-800: rgba(41, 150, 161, 1);
      --color-red-400: rgba(255, 84, 89, 1);
      --color-red-500: rgba(192, 21, 47, 1);
      --color-orange-400: rgba(230, 129, 97, 1);
      --color-orange-500: rgba(168, 75, 47, 1);

      /* Christmas colors */
      --christmas-red: #8B0000;
      --christmas-green: #228B22;
      --christmas-gold: #FFD700;
      --christmas-silver: #C0C0C0;
      --winter-blue: #4169E1;
    }
    
    body {
      background: linear-gradient(135deg, #000428 0%, #004e92 100%);
      min-height: 100vh;
      overflow-x: hidden;
    }
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: -1;
    }
    .stars, .snow {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: transparent;
      overflow: hidden;
      z-index: -1;
      pointer-events: none;
    }
    .star, .flake {
      position: absolute;
      border-radius: 50%;
      opacity: 0.8;
    }
    .star {
      width: 2px;
      height: 2px;
      background: white;
      animation: twinkle 2s infinite ease-in-out;
    }
    @keyframes twinkle {
      0%, 100% { opacity: 0.2; }
      50% { opacity: 1; }
    }
    .flake {
      width: 6px;
      height: 6px;
      background: white;
      opacity: 0.7;
      animation: fall linear infinite;
    }
    @keyframes fall {
      0% { transform: translateY(-10px); opacity: 0; }
      20% { opacity: 1; }
      100% { transform: translateY(100vh); opacity: 0; }
    }

    .celebration {
      animation: glow 1s ease-in-out infinite alternate;
    }
    @keyframes glow {
      from { box-shadow: 0 0 10px #fbbf24, 0 0 20px #fbbf24; }
      to { box-shadow: 0 0 20px #f59e0b, 0 0 30px #f59e0b; }
    }

    .full-screen-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 50;
      padding: 2rem;
      overflow-y: auto;
      animation: fadeIn 0.3s ease-in-out;
    }
    .close-button {
      position: absolute;
      top: 1rem;
      right: 1rem;
      font-size: 2rem;
      cursor: pointer;
      background: none;
      border: none;
      color: white;
      transition: transform 0.2s ease;
    }
    .close-button:hover {
      transform: scale(1.2);
      color: #f87171;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .modal-content {
      animation: slideUp 0.3s ease-in-out;
      max-width: 700px;
      width: 100%;
      background: #1f2937;
      border-radius: 1rem;
      padding: 2rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.6);
    }
    .option-button {
      transition: all 0.2s ease;
    }
    .option-button:hover {
      transform: scale(1.05);
    }
    .feedback {
      margin-top: 1rem;
      font-size: 1.1rem;
      font-weight: bold;
      text-align: center;
    }
    .feedback.correct { color: #4ade80; }
    .feedback.wrong { color: #f87171; }
    
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background: #1f2937;
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 0.5rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.6);
      animation: slideInRight 0.3s ease-out;
    }
    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .save-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.875rem;
      font-weight: 500;
    }
    .save-indicator.saved {
      background: rgba(34, 197, 94, 0.2);
      color: #4ade80;
    }
    .save-indicator.saving {
      background: rgba(234, 179, 8, 0.2);
      color: #facc15;
    }
    .save-indicator.error {
      background: rgba(239, 68, 68, 0.2);
      color: #f87171;
    }
    
    .backup-section {
      background: rgba(17, 24, 39, 0.8);
      padding: 1.5rem;
      border-radius: 1rem;
      margin: 1rem 0;
      border: 1px solid rgba(75, 85, 99, 0.3);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .stat-card {
      background: rgba(17, 24, 39, 0.6);
      padding: 1rem;
      border-radius: 0.5rem;
      text-align: center;
      border: 1px solid rgba(75, 85, 99, 0.2);
    }
    
    /* Login Screen Styles */
    .login-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #000428 0%, #004e92 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 100;
    }
    
    .login-form {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      padding: 3rem;
      border-radius: 1.5rem;
      border: 2px solid var(--christmas-gold);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
      text-align: center;
      min-width: 400px;
    }
    
    .login-title {
      color: var(--christmas-gold);
      font-size: 2.5rem;
      font-weight: bold;
      margin-bottom: 1rem;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }
    
    .login-subtitle {
      color: white;
      margin-bottom: 2rem;
      opacity: 0.9;
    }
    
    .login-input {
      width: 100%;
      padding: 1rem;
      margin: 0.5rem 0;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 0.75rem;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 1.1rem;
      transition: all 0.3s ease;
    }
    
    .login-input:focus {
      outline: none;
      border-color: var(--christmas-gold);
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
    }
    
    .login-input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }
    
    .login-button {
      width: 100%;
      padding: 1rem;
      margin-top: 1rem;
      background: linear-gradient(45deg, var(--christmas-red), var(--christmas-green));
      color: white;
      border: none;
      border-radius: 0.75rem;
      font-size: 1.2rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .login-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
    }
    
    .login-error {
      color: #ff6b6b;
      margin-top: 1rem;
      font-weight: bold;
      animation: shake 0.5s ease-in-out;
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    
    /* Header Controls Styles */
    .header-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .control-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
      font-weight: 500;
    }

    .control-btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .export-btn {
      background: #10b981;
      color: white;
    }

    .import-btn {
      background: #3b82f6;
      color: white;
    }

    .leaderboard-btn {
      background: #f59e0b;
      color: white;
    }

    .logout-btn {
      background: #ef4444;
      color: white;
    }

    /* Export Modal Styles */
    .export-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease-in-out;
    }

    .export-content {
      background: #1f2937;
      padding: 2rem;
      border-radius: 1rem;
      max-width: 600px;
      width: 90%;
      color: white;
      text-align: center;
    }

    .export-content h2 {
      color: #10b981;
      margin-bottom: 1rem;
      font-size: 1.8rem;
    }

    .export-code {
      width: 100%;
      height: 120px;
      background: #374151;
      border: 1px solid #4b5563;
      border-radius: 0.5rem;
      padding: 1rem;
      color: #f3f4f6;
      font-family: monospace;
      font-size: 0.9rem;
      resize: none;
      margin: 1rem 0;
    }

    .export-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 1.5rem;
    }

    .copy-btn {
      background: #10b981;
      color: white;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s ease;
    }

    .copy-btn:hover {
      background: #059669;
      transform: translateY(-1px);
    }

    .close-btn {
      background: #6b7280;
      color: white;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .close-btn:hover {
      background: #4b5563;
    }

    /* Christmas Card Styles */
    .christmas-card {
      background: linear-gradient(135deg, var(--christmas-red) 0%, var(--christmas-green) 100%);
      border: 2px solid var(--christmas-gold);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 215, 0, 0.2);
      transition: all 0.3s ease;
    }
    
    .christmas-card:hover {
      transform: translateY(-5px) scale(1.02);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4), 0 0 30px rgba(255, 215, 0, 0.4);
    }
    
    .christmas-card.completed {
      background: linear-gradient(135deg, var(--christmas-gold) 0%, #ffa500 100%);
      animation: sparkle 2s infinite ease-in-out;
    }
    
    @keyframes sparkle {
      0%, 100% { box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 215, 0, 0.3); }
      50% { box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3), 0 0 40px rgba(255, 215, 0, 0.6); }
    }
    
    /* Header Styles */
    .app-header {
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 215, 0, 0.3);
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .header-title {
      color: var(--christmas-gold);
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
      font-family: serif;
    }
    
    /* Leaderboard Styles */
    .leaderboard {
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(15px);
      border: 2px solid var(--christmas-gold);
      border-radius: 1rem;
      padding: 2rem;
      max-width: 600px;
      width: 100%;
    }
    
    .leaderboard-title {
      color: var(--christmas-gold);
      text-align: center;
      margin-bottom: 1.5rem;
      font-size: 2rem;
      font-weight: bold;
    }
    
    .leaderboard-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      margin: 0.5rem 0;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 0.5rem;
      transition: all 0.3s ease;
    }
    
    .leaderboard-row.current-user {
      background: rgba(255, 215, 0, 0.2);
      border: 1px solid var(--christmas-gold);
    }
    
    .leaderboard-row:hover {
      transform: translateX(5px);
      background: rgba(255, 255, 255, 0.15);
    }
    
    .rank-badge {
      background: var(--christmas-gold);
      color: black;
      padding: 0.5rem;
      border-radius: 50%;
      font-weight: bold;
      min-width: 40px;
      text-align: center;
    }
    
    .rank-badge.first {
      background: #FFD700;
    }
    
    .rank-badge.second {
      background: #C0C0C0;
    }
    
    .rank-badge.third {
      background: #CD7F32;
    }
    
    /* Calendar Grid Styles */
    #calendarGrid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      padding: 1rem;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .calendar-day {
      padding: 1.5rem;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    
    .calendar-day.available {
      background: linear-gradient(135deg, #4ade80 0%, #22d3ee 100%);
      color: white;
      border-color: rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 15px rgba(34, 211, 238, 0.3);
    }
    
    .calendar-day.locked {
      background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
      color: #9ca3af;
      cursor: not-allowed;
      opacity: 0.7;
    }
    
    .calendar-day.completed {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: #1f2937;
      border-color: #fbbf24;
      box-shadow: 0 4px 15px rgba(251, 191, 36, 0.4);
      animation: sparkle 2s infinite ease-in-out;
    }
    
    .calendar-day:hover.available {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 8px 25px rgba(34, 211, 238, 0.4);
    }
    
    .calendar-day:hover.completed {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 8px 25px rgba(251, 191, 36, 0.5);
    }
    
    .calendar-day h2 {
      font-size: 1.25rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    
    .calendar-day .day-icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    
    .calendar-day .day-status {
      font-size: 0.875rem;
      font-weight: 600;
    }
    
    @media (max-width: 768px) {
      #calendarGrid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
        padding: 0.75rem;
      }
      
      .calendar-day {
        padding: 1rem;
        min-height: 100px;
      }
    }
    
    @media (max-width: 480px) {
      #calendarGrid {
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
        padding: 0.5rem;
      }
      
      .calendar-day {
        padding: 0.75rem;
        min-height: 80px;
      }
      
      .calendar-day h2 {
        font-size: 1rem;
      }
      
      .calendar-day .day-icon {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body class="text-white min-h-screen flex flex-col items-center p-4 overflow-y-auto relative">
  <div class="overlay"></div>
  <div class="stars" id="stars"></div>
  <div class="snow" id="snow"></div>

  <!-- Login Screen -->
  <div id="loginScreen" class="login-screen">
    <div class="login-form">
      <h1 class="login-title">🎄 Calendario dell'Avvento</h1>
      <p class="login-subtitle">✨ Costellazioni di Natale ✨</p>
      
      <div id="login-form">
        <input id="usernameInput" type="text" placeholder="👤 Username" class="login-input" autocomplete="username">
        <input id="passwordInput" type="password" placeholder="🔒 Password" class="login-input" autocomplete="current-password">
        <button id="loginBtn" class="login-button">🎅 Accedi</button>
        <div id="loginError" class="login-error" style="display: none;"></div>
      </div>
      
      <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.2);">
        <p style="color: rgba(255,255,255,0.7); font-size: 0.9rem; margin-bottom: 0.5rem;">Utenti disponibili:</p>
        <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6); line-height: 1.4;">
          <strong>mario</strong> / natale2025<br>
          <strong>lucia</strong> / stella123<br>
          <strong>andrea</strong> / avvento25
        </div>
      </div>
    </div>
  </div>

  <!-- Main App Content -->
  <div id="mainApp" class="w-full max-w-6xl relative z-10" style="display: none;">
    <!-- App Header -->
    <div class="app-header">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="header-title text-4xl font-extrabold mb-2">🎄 Calendario dell'Avvento - Costellazioni ✨</h1>
          <div id="userWelcome" class="text-xl text-white">
            Benvenuto <strong id="display-name" class="text-yellow-300"></strong>!
          </div>
          <div class="flex items-center gap-4 mt-2">
            <h2 id="totalScore" class="text-lg font-semibold text-white">⭐ Punteggio: 0</h2>
            <span id="days-completed" class="text-lg font-semibold text-white">📅 Giorni completati: 0/31</span>
          </div>
        </div>
        <div class="header-controls flex gap-3">
          <button id="leaderboardBtn" class="control-btn leaderboard-btn px-4 py-2 bg-yellow-600 hover:bg-yellow-700 rounded-lg transition-colors font-bold">
            🏆 Classifica
          </button>
          <button id="exportBtn" class="control-btn export-btn px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition-colors font-bold">
            📤 Esporta
          </button>
          <button id="importBtn" class="control-btn import-btn px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors font-bold">
            📥 Importa
          </button>
          <button id="logoutBtn" class="control-btn logout-btn px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition-colors">
            🚪 Logout
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="app" class="w-full max-w-6xl relative z-10"></div>
  
  <!-- Toast Container -->
  <div id="toast-container"></div>

  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script>
    // Stelle scintillanti
    const starContainer = document.getElementById('stars');
    for (let i = 0; i < 150; i++) {
      const star = document.createElement('div');
      star.classList.add('star');
      star.style.top = Math.random() * 100 + '%';
      star.style.left = Math.random() * 100 + '%';
      starContainer.appendChild(star);
    }
    // Fiocchi di neve
    const snowContainer = document.getElementById('snow');
    for (let i = 0; i < 50; i++) {
      const flake = document.createElement('div');
      flake.classList.add('flake');
      flake.style.left = Math.random() * 100 + '%';
      flake.style.animationDuration = 5 + Math.random() * 5 + 's';
      flake.style.animationDelay = Math.random() * 5 + 's';
      snowContainer.appendChild(flake);
    }

    const { useState, useEffect } = React;

    // Sistema utenti hardcoded
    const USERS = {
      "mario": { password: "natale2025", displayName: "Mario" },
      "lucia": { password: "stella123", displayName: "Lucia" },
      "andrea": { password: "avvento25", displayName: "Andrea" }
    };

    // ========================================
    // MEMORIA GLOBALE - SOSTITUTO STORAGE
    // ========================================
    window.ADVENT_DATA = {
      currentUser: null,
      users: {
        mario: { displayName: 'Mario', totalScore: 0, progress: {} },
        lucia: { displayName: 'Lucia', totalScore: 0, progress: {} },
        andrea: { displayName: 'Andrea', totalScore: 0, progress: {} }
      }
    };

    console.log('💾 Sistema memoria inizializzato:', window.ADVENT_DATA);

    // Dati delle costellazioni con informazioni dettagliate (aggiornati con dati reali)
    const CONSTELLATIONS = [
      {
        name: "Orsa Maggiore",
        options: ["Orsa Maggiore", "Orsa Minore", "Cassiopea", "Andromeda"],
        description: "Una delle costellazioni più famose del cielo settentrionale, facilmente riconoscibile per la sua forma caratteristica a 'Grande Carro'.",
        hints: [
          "È conosciuta anche come 'Grande Carro'",
          "Contiene sette stelle principali molto luminose", 
          "Le sue stelle puntano verso la Stella Polare"
        ]
      },
      {
        name: "Cassiopea",
        options: ["Cassiopea", "Andromeda", "Perseo", "Cigno"],
        description: "Riconoscibile per la sua forma a 'W' o 'M', è una costellazione circumpolare facilmente visibile tutto l'anno.",
        hints: [
          "Ha la forma di una 'W' o di una 'M'",
          "È circumpolare, sempre visibile alle nostre latitudini",
          "Prende il nome da una regina della mitologia greca"
        ]
      },
      {
        name: "Orione",
        options: ["Orione", "Scorpione", "Leone", "Sagittario"],
        description: "La costellazione del cacciatore, una delle più spettacolari del cielo invernale, con la famosa Nebulosa di Orione.",
        hints: [
          "È la costellazione del cacciatore nella mitologia",
          "Contiene la famosa cintura di tre stelle",
          "È visibile principalmente in inverno"
        ]
      },
      {
        name: "Andromeda",
        options: ["Andromeda", "Cassiopea", "Perseo", "Pegaso"],
        description: "Costellazione che contiene la famosa Galassia di Andromeda, visibile a occhio nudo in cieli bui.",
        hints: [
          "Contiene la galassia più vicina alla Via Lattea",
          "È collegata al mito di Perseo e della principessa",
          "La sua galassia è visibile a occhio nudo"
        ]
      },
      {
        name: "Perseo",
        options: ["Perseo", "Andromeda", "Cassiopea", "Auriga"],
        description: "Costellazione che rappresenta l'eroe della mitologia greca che salvò Andromeda.",
        hints: [
          "È l'eroe che salvò Andromeda nella mitologia",
          "Contiene l'ammasso stellare delle Pleiadi nelle vicinanze",
          "È visibile in autunno e inverno"
        ]
      },
      {
        name: "Cigno",
        options: ["Cigno", "Aquila", "Lira", "Drago"],
        description: "Una grande costellazione estiva, facilmente riconoscibile per la sua forma a croce.",
        hints: [
          "Ha la forma di una grande croce nel cielo",
          "È una delle costellazioni più grandi",
          "Contiene la stella Deneb, una delle più luminose"
        ]
      },
      {
        name: "Aquila",
        options: ["Aquila", "Cigno", "Lira", "Freccia"],
        description: "Costellazione che rappresenta l'aquila di Zeus nella mitologia greca.",
        hints: [
          "Rappresenta l'aquila di Zeus",
          "Contiene la stella brillante Altair",
          "È parte del triangolo estivo"
        ]
      },
      {
        name: "Lira",
        options: ["Lira", "Cigno", "Aquila", "Ercole"],
        description: "Piccola costellazione che contiene Vega, una delle stelle più brillanti del cielo.",
        hints: [
          "Contiene Vega, stella molto brillante",
          "Rappresenta lo strumento musicale di Orfeo",
          "È piccola ma molto riconoscibile"
        ]
      },
      {
        name: "Drago",
        options: ["Drago", "Orsa Minore", "Cefeo", "Giraffa"],
        description: "Una grande costellazione circumpolare che si avvolge attorno al polo nord celeste.",
        hints: [
          "Si avvolge attorno al polo nord celeste",
          "È una costellazione molto estesa",
          "È sempre visibile alle nostre latitudini"
        ]
      },
      {
        name: "Boote",
        options: ["Boote", "Vergine", "Corona Boreale", "Ercole"],
        description: "Costellazione primaverile che contiene Arturo, una delle stelle più brillanti.",
        hints: [
          "Contiene Arturo, stella molto brillante",
          "È chiamato anche il Pastore",
          "È ben visibile in primavera"
        ]
      }
    ];
    
    // Generiamo 31 costellazioni utilizzando quelle base
    const FULL_CONSTELLATIONS = Array.from({ length: 31 }, (_, i) => {
      const base = CONSTELLATIONS[i % CONSTELLATIONS.length];
      return {
        ...base,
        name: i < CONSTELLATIONS.length ? base.name : `${base.name} ${Math.floor(i / CONSTELLATIONS.length) + 1}`,
        description: i < CONSTELLATIONS.length ? base.description : `${base.description} (Variazione ${Math.floor(i / CONSTELLATIONS.length) + 1})`
      };
    });

    // ========================================
    // SISTEMA MEMORIA PURA - NO STORAGE API
    // ========================================
    
    function saveProgress(username, dayIndex, finalScore) {
      if (!window.ADVENT_DATA.users[username]) {
        window.ADVENT_DATA.users[username] = { displayName: username, totalScore: 0, progress: {} };
      }
      
      window.ADVENT_DATA.users[username].progress[dayIndex] = {
        solved: true,
        finalScore: finalScore,
        completedAt: new Date().toISOString()
      };
      
      // Ricalcola punteggio totale
      const user = window.ADVENT_DATA.users[username];
      user.totalScore = Object.values(user.progress)
        .reduce((sum, day) => sum + (day.finalScore || 0), 0);
        
      console.log(`💾 Salvato in memoria ${username}:`, user);
    }

    function saveUserProgress(username, progress) {
      if (!window.ADVENT_DATA.users[username]) {
        window.ADVENT_DATA.users[username] = { displayName: username, totalScore: 0, progress: {} };
      }
      
      window.ADVENT_DATA.users[username].progress = { ...progress };
      
      // Ricalcola punteggio totale
      const user = window.ADVENT_DATA.users[username];
      user.totalScore = Object.values(user.progress)
        .reduce((sum, day) => sum + (day.finalScore !== undefined ? day.finalScore : (day.score || 0)), 0);
        
      console.log(`💾 Progresso completo salvato per ${username}:`, user);
    }

    function getProgress(username) {
      return window.ADVENT_DATA.users[username]?.progress || {};
    }

    function getUserData(username) {
      return window.ADVENT_DATA.users[username] || { displayName: username, totalScore: 0, progress: {} };
    }

    function getLeaderboard() {
      const leaderboard = [];
      
      Object.keys(window.ADVENT_DATA.users).forEach(username => {
        const user = window.ADVENT_DATA.users[username];
        const completedDays = Object.keys(user.progress).length;
        
        if (completedDays > 0) {
          leaderboard.push({
            username,
            name: user.displayName,
            score: user.totalScore,
            days: completedDays
          });
        }
      });
      
      console.log('🏆 Classifica da memoria:', leaderboard);
      return leaderboard.sort((a, b) => b.score - a.score);
    }

    // Export/Import con codifica base64
    function exportProgressCode() {
      const data = JSON.stringify(window.ADVENT_DATA);
      const code = btoa(data);
      console.log('📤 Dati esportati:', code.length, 'caratteri');
      return code;
    }

    function importProgressCode(code) {
      try {
        const data = JSON.parse(atob(code));
        window.ADVENT_DATA = { ...data };
        console.log('📥 Dati importati con successo:', Object.keys(window.ADVENT_DATA.users).length, 'utenti');
        return true;
      } catch (error) {
        console.error('❌ Codice non valido:', error);
        return false;
      }
    }

    function clearAllData() {
      window.ADVENT_DATA = {
        currentUser: null,
        users: {
          mario: { displayName: 'Mario', totalScore: 0, progress: {} },
          lucia: { displayName: 'Lucia', totalScore: 0, progress: {} },
          andrea: { displayName: 'Andrea', totalScore: 0, progress: {} }
        }
      };
      console.log('🗑️ Tutti i dati resettati');
    }

    // Utility functions
    function shuffleArray(array) {
      const shuffled = [...array]; 
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    function generateBackupCode(data) {
      const jsonString = JSON.stringify(data);
      return btoa(encodeURIComponent(jsonString));
    }

    function parseBackupCode(code) {
      try {
        const jsonString = decodeURIComponent(atob(code));
        return JSON.parse(jsonString);
      } catch (error) {
        throw new Error('Codice di backup non valido');
      }
    }

    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = 'toast';
      
      const colors = {
        success: '#4ade80',
        error: '#f87171',
        warning: '#facc15',
        info: '#60a5fa'
      };
      
      toast.style.borderLeft = `4px solid ${colors[type]}`;
      toast.textContent = message;
      
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    function updateSaveStatus(status) {
      // Funzione semplificata per evitare errori DOM
      console.log('💾 Stato salvataggio:', status);
    }

    // Login Manager
    function LoginManager() {
      useEffect(() => {
        console.log('🚀 Inizializzazione LoginManager...');
        
        // Verifica elementi critici di login
        const loginBtn = document.getElementById('loginBtn');
        const usernameInput = document.getElementById('usernameInput');
        const passwordInput = document.getElementById('passwordInput');
        const loginError = document.getElementById('loginError');

        console.log('🔍 Elementi login trovati:', {
          loginBtn: !!loginBtn,
          usernameInput: !!usernameInput,
          passwordInput: !!passwordInput,
          loginError: !!loginError
        });

        if (!loginBtn || !usernameInput || !passwordInput || !loginError) {
          console.error('❌ ERRORE CRITICO: Elementi login mancanti!');
          return;
        }

        function handleLogin() {
          const username = usernameInput.value.trim().toLowerCase();
          const password = passwordInput.value;
          
          console.log('🔐 Tentativo login per:', username);
          
          if (USERS[username] && USERS[username].password === password) {
            console.log('✅ Login valido per:', username);
            
            try {
              // Initialize main app with user FIRST
              initMainApp(username);
              
              showToast(`Benvenuto ${USERS[username].displayName}!`, 'success');
              console.log('🎉 Login completato con successo');
            } catch (error) {
              console.error('❌ Errore durante il login:', error);
              showToast('Errore durante l\'accesso', 'error');
              // Fallback: ricarica la pagina
              location.reload();
            }
          } else {
            // Login failed
            loginError.textContent = '❌ Username o password non corretti';
            loginError.style.display = 'block';
            
            setTimeout(() => {
              loginError.style.display = 'none';
            }, 3000);
          }
        }

        console.log('🔗 Aggiunta event listeners login...');
        loginBtn.addEventListener('click', handleLogin);
        
        // Enter key support
        [usernameInput, passwordInput].forEach(input => {
          input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              handleLogin();
            }
          });
        });

        console.log('✅ LoginManager completamente inizializzato');
        return () => {
          loginBtn.removeEventListener('click', handleLogin);
        };
      }, []);

      return null;
    }

    // Main App State
    let currentUser = null;
    let mainAppInstance = null;

    function initMainApp(username) {
      console.log('🎯 Inizializzando app principale per:', username);
      
      try {
        // Verifica che tutti gli elementi esistano PRIMA di usarli
        const loginScreen = document.getElementById('loginScreen');
        const mainApp = document.getElementById('mainApp');
        const userWelcome = document.getElementById('userWelcome');
        const totalScore = document.getElementById('totalScore');
        const leaderboardBtn = document.getElementById('leaderboardBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const calendarGrid = document.getElementById('calendarGrid');
        const container = document.getElementById('app');
        const displayNameEl = document.getElementById('display-name');
        
        // Debug: verifica elementi
        console.log('🔍 Elementi DOM trovati:', {
          loginScreen: !!loginScreen,
          mainApp: !!mainApp,
          userWelcome: !!userWelcome,
          totalScore: !!totalScore,
          leaderboardBtn: !!leaderboardBtn,
          logoutBtn: !!logoutBtn,
          calendarGrid: !!calendarGrid,
          container: !!container,
          displayNameEl: !!displayNameEl
        });
        
        // Solo se TUTTI gli elementi esistono, procedi
        if (loginScreen && mainApp && userWelcome && totalScore && leaderboardBtn && logoutBtn && container) {
          console.log('✅ Tutti gli elementi DOM verificati, procedendo...');
          
          // Imposta utente corrente
          currentUser = username;
          
          // Nascondi login, mostra app
          loginScreen.style.display = 'none';
          mainApp.style.display = 'block';
          
          // Update display name
          if (displayNameEl) {
            displayNameEl.textContent = USERS[username].displayName;
            console.log('✅ Nome utente aggiornato:', USERS[username].displayName);
          }
          
          // Aggiungi event listeners SOLO se elementi esistono
          console.log('🔗 Aggiunta event listeners...');
          
          leaderboardBtn.addEventListener('click', () => {
            console.log('🏆 Clic leaderboard');
            showLeaderboard();
          });
          
          // Export button functionality
          const exportBtn = document.getElementById('exportBtn');
          if (exportBtn) {
            exportBtn.addEventListener('click', () => {
              console.log('📤 Export richiesto');
              exportProgress();
            });
          }

          // Import button functionality
          const importBtn = document.getElementById('importBtn');
          if (importBtn) {
            importBtn.addEventListener('click', () => {
              console.log('📥 Import richiesto');
              importProgress();
            });
          }

          logoutBtn.addEventListener('click', () => {
            console.log('🚪 Logout richiesto');
            try {
              mainApp.style.display = 'none';
              loginScreen.style.display = 'flex';
              
              // Clear form
              const usernameInput = document.getElementById('usernameInput');
              const passwordInput = document.getElementById('passwordInput');
              if (usernameInput) usernameInput.value = '';
              if (passwordInput) passwordInput.value = '';
              
              // Unmount main app
              if (mainAppInstance) {
                ReactDOM.unmountComponentAtNode(container);
                mainAppInstance = null;
              }
              
              currentUser = null;
              showToast('Logout effettuato', 'info');
            } catch (logoutError) {
              console.error('❌ Errore durante logout:', logoutError);
              location.reload();
            }
          });
          
          // Render main app component
          try {
            console.log('🎨 Rendering componente principale...');
            mainAppInstance = ReactDOM.createRoot(container);
            mainAppInstance.render(React.createElement(App, { username }));
            console.log('✅ App principale renderizzata con successo');
          } catch (renderError) {
            console.error('❌ Errore rendering app principale:', renderError);
            showToast('Errore caricamento interfaccia', 'error');
            throw renderError;
          }
          
          console.log('✅ App principale inizializzata con successo');
        } else {
          throw new Error('Elementi DOM critici mancanti');
        }
        
      } catch (error) {
        console.error('❌ Errore inizializzazione app:', error);
        console.error('📍 Stack trace:', error.stack);
        showToast('Errore critico. Ricaricando...', 'error');
        // Fallback: ricarica pagina
        setTimeout(() => location.reload(), 2000);
      }
    }

    // Componente principale
    function App({ username }) {
      const [initialized, setInitialized] = useState(false);
      
      const today = new Date();
      const currentDay = today.getDate();
      const currentMonth = today.getMonth(); // 0-based (dicembre = 11)
      const currentYear = today.getFullYear();
      
      // LOGICA CORRETTA PER TESTING - 17 ottobre 2025
      let maxDay;
      
      console.log("📅 Data corrente:", today);
      console.log("📅 Mese corrente:", currentMonth, "(0=gen, 9=ott, 11=dic)");
      console.log("📅 Giorno corrente:", currentDay);
      
      if (currentMonth === 11 && currentYear === 2025) { 
        // Se siamo a dicembre 2025, sblocca fino al giorno corrente
        maxDay = currentDay;
        console.log("🗓️ Modalità dicembre: giorni sbloccati fino al", maxDay);
      } else if (currentMonth < 11 || currentYear < 2025) { 
        // Se siamo PRIMA di dicembre (come ora ottobre), sblocca i primi 5 giorni per TESTING
        maxDay = 5; // FISSO per testing
        console.log("🧪 Modalità testing PRE-dicembre: giorni sbloccati:", maxDay);
      } else { 
        // Se siamo DOPO dicembre, sblocca tutto
        maxDay = 31;
        console.log("🎉 Modalità post-dicembre: tutti i giorni sbloccati");
      }
      
      console.log("✅ Giorni max disponibili:", maxDay);
      
      // FALLBACK DI EMERGENZA come richiesto
      if (typeof maxDay !== 'number' || isNaN(maxDay) || maxDay < 0) {
        console.warn("⚠️ FALLBACK ATTIVATO: Logica date fallita, forzando 5 giorni per testing");
        maxDay = 5;
      }
      
      const [progress, setProgress] = useState({});
      const [activeModal, setActiveModal] = useState(null);
      const [settingsModal, setSettingsModal] = useState(false);
      const [initError, setInitError] = useState(null);
      
      // Gestione apertura settings da pulsante esterno
      useEffect(() => {
        const handleOpenSettings = () => setSettingsModal(true);
        window.addEventListener('openSettings', handleOpenSettings);
        return () => window.removeEventListener('openSettings', handleOpenSettings);
      }, []);
      

      const [feedback, setFeedback] = useState("");
      const [wrongAnswer, setWrongAnswer] = useState(null);
      const [totalScore, setTotalScore] = useState(0);
      const [stats, setStats] = useState({});
      
      // BUG FIX #1: Stato per opzioni mescolate una sola volta per modal
      const [shuffledOptions, setShuffledOptions] = useState({});

      // Inizializzazione MEMORIA PURA - no storage API
      useEffect(() => {
        function initApp() {
          console.log('🚀 Inizializzando app per utente:', username);
          console.log('👤 Utente loggato:', username, '- Nome:', USERS[username]?.displayName);
          
          try {
            // Imposta utente corrente
            window.ADVENT_DATA.currentUser = username;
            
            // Carica progresso dalla memoria
            const savedProgress = getProgress(username);
            console.log('✅ Progresso caricato da memoria:', Object.keys(savedProgress).length, 'giorni');
            
            setProgress(savedProgress);
            setInitialized(true);
            console.log('✅ App completamente inizializzata con memoria pura');
            console.log('🎯 Giorni nel progresso salvato:', Object.keys(savedProgress));
          } catch (error) {
            console.error('❌ Errore inizializzazione app:', error);
            setInitError(error.message);
            // Inizializzazione di fallback - app funziona comunque
            setProgress({});
            setInitialized(true);
            showToast('App avviata in modalità di recupero', 'warning');
          }
        }
        
        // Avvio immediato
        initApp();
      }, [username]);

      // SALVATAGGIO IN MEMORIA PURA
      useEffect(() => {
        if (!initialized) return;
        
        function saveCurrentProgress() {
          try {
            console.log('=== SALVATAGGIO MEMORIA PURA ===');
            
            // Salva progresso completo per l'utente corrente
            saveUserProgress(username, progress);
            
            const userData = getUserData(username);
            console.log(`✅ SALVATO in memoria [${username}]:`, {
              punteggio_totale: userData.totalScore,
              giorni_completati: Object.values(progress).filter(e => e.solved).length,
              giorni_nel_progress: Object.keys(progress).length,
              esempio_giorno: Object.keys(progress).length > 0 ? progress[Object.keys(progress)[0]] : 'nessuno'
            });
            
          } catch (error) {
            console.error('❌ Errore salvataggio:', error);
          }
        }
        
        saveCurrentProgress();
      }, [progress, initialized, username]);

      // BUG FIX #2 & #3: Calcolo statistiche con debug intensivo
      useEffect(() => {
        console.log('=== CALCOLO STATISTICHE DETTAGLIATO ===');
        
        let score = 0;
        let completed = 0;
        let totalAttempts = 0;
        let totalHints = 0;
        
        Object.entries(progress).forEach(([dayIndex, entry]) => {
          // BUG FIX #3: Priorità a finalScore per giorni completati
          const entryScore = entry.finalScore !== undefined ? entry.finalScore : (entry.score || 0);
          score += entryScore;
          
          console.log(`📈 Giorno ${parseInt(dayIndex) + 1}:`, {
            completato: entry.solved,
            punteggio_usato: entryScore,
            punteggio_corrente: entry.score,
            punteggio_finale: entry.finalScore,
            tentativi: entry.attempts || 0,
            indizi: entry.usedHints || 0
          });
          
          if (entry.solved) completed++;
          totalAttempts += entry.attempts || 0;
          totalHints += entry.usedHints || 0;
        });
        
        const newStats = {
          totalScore: score,
          completedDays: completed,
          totalAttempts,
          totalHints,
          accuracy: totalAttempts > 0 ? Math.round((completed / totalAttempts) * 100) : 0
        };
        
        console.log('🏆 STATISTICHE FINALI:', newStats);
        console.log('👤 Utente corrente per salvataggio:', currentUser);
        
        setStats(newStats);
        setTotalScore(score);
      }, [progress]);

      // Aggiornamento UI
      useEffect(() => {
        const totalScoreEl = document.getElementById("totalScore");
        const daysCompletedEl = document.getElementById("days-completed");
        
        if (totalScoreEl) {
          totalScoreEl.innerText = `⭐ Punteggio: ${totalScore}`;
        }
        
        if (daysCompletedEl) {
          const completed = Object.values(progress).filter(entry => entry.solved).length;
          daysCompletedEl.innerText = `📅 Giorni completati: ${completed}/31`;
        }
        
        // BUG FIX #3: Log per debug classifica
        console.log('🔄 UI Aggiornata:', {
          utente: currentUser,
          punteggio_totale: totalScore,
          giorni_completati: Object.values(progress).filter(entry => entry.solved).length,
          progressi_salvati: Object.keys(progress).length
        });
      }, [totalScore, progress]);

      // BUG FIX #2: LOGICA PUNTI COMPLETAMENTE RISCRITTA
      function handleAnswer(index, choice) {
        const correct = FULL_CONSTELLATIONS[index].name;
        setProgress(prev => {
          const entry = prev[index] || { attempts: 0, solved: false, score: 3, usedHints: 0 };
          if (entry.solved) return prev;
          
          if (choice === correct) {
            entry.solved = true;
            entry.finalScore = entry.score; // BUG FIX #3: Salva punteggio finale
            
            console.log(`✅ RISPOSTA CORRETTA Giorno ${index + 1}:`, {
              punteggio_finale: entry.score,
              tentativi_totali: entry.attempts + 1,
              indizi_usati: entry.usedHints
            });
            
            setFeedback("✅ Corretto! Ottimo lavoro!");
            setWrongAnswer(null);
            
            const scoreText = entry.score >= 0 ? `+${entry.score}` : `${entry.score}`;
            showToast(`Giorno ${index + 1} completato! ${scoreText} punti`, 'success');
          } else {
            // BUG FIX #2: Decrementa PRIMA di incrementare attempts
            entry.score = entry.score - 1; // Può diventare negativo!
            entry.attempts += 1;
            
            console.log(`❌ RISPOSTA SBAGLIATA Giorno ${index + 1}:`, {
              risposta_data: choice,
              risposta_corretta: correct,
              punti_rimasti: entry.score,
              tentativi: entry.attempts
            });
            
            setWrongAnswer(choice);
            const scoreDisplay = entry.score >= 0 ? `+${entry.score}` : `${entry.score}`;
            setFeedback(`❌ Risposta sbagliata! Punti rimasti: ${scoreDisplay}`);
          }
          
          return { ...prev, [index]: entry };
        });
      }

      // BUG FIX #2: LOGICA INDIZI CORRETTA
      function useHint(index) {
        setProgress(prev => {
          const entry = prev[index] || { attempts: 0, solved: false, score: 3, usedHints: 0 };
          if (entry.solved || entry.usedHints >= 3) return prev;
          
          // BUG FIX #2: Decrementa SEMPRE di 1, anche in negativo
          entry.score = entry.score - 1; // NO Math.max! Permetti negativi!
          entry.usedHints += 1;
          
          console.log(`💡 INDIZIO USATO Giorno ${index + 1}:`, {
            indizi_totali: entry.usedHints,
            punti_dopo_indizio: entry.score,
            formula_corretta: `Punti = punti_precedenti - 1 = ${entry.score + 1} - 1 = ${entry.score}`
          });
          
          const hint = FULL_CONSTELLATIONS[index].hints[entry.usedHints - 1];
          const scoreDisplay = entry.score >= 0 ? `+${entry.score}` : `${entry.score}`;
          setFeedback(`💡 Indizio usato: ${hint} (Punti rimasti: ${scoreDisplay})`);
          
          return { ...prev, [index]: entry };
        });
      }

      function exportUserProgress() {
        try {
          const code = exportProgressCode();
          navigator.clipboard.writeText(code).then(() => {
            showToast('Codice di backup copiato negli appunti!', 'success');
          }).catch(() => {
            showToast('Codice generato (copia manualmente): ' + code.substring(0, 20) + '...', 'info');
          });
          return code;
        } catch (error) {
          showToast('Errore nella generazione del backup', 'error');
          console.error('Errore export:', error);
        }
      }

      function importUserProgress(backupCode) {
        try {
          const success = importProgressCode(backupCode);
          if (success) {
            // Ricarica il progresso dell'utente corrente
            const newProgress = getProgress(username);
            setProgress(newProgress);
            showToast('Progresso importato con successo!', 'success');
          } else {
            throw new Error('Dati non validi');
          }
        } catch (error) {
          showToast('Codice di backup non valido', 'error');
          console.error('Errore import:', error);
        }
      }

      function resetUserProgress() {
        if (confirm('Sei sicuro di voler resettare tutto il progresso? Questa azione non può essere annullata.')) {
          clearAllData();
          setProgress({});
          showToast('Progresso resettato', 'success');
        }
      }



      // RIMOSSO loading screen problematico - inizializzazione immediata
      if (!initialized) {
        console.log('⏳ App non ancora inizializzata, mostrando loading...');
        return React.createElement('div', { className: 'text-center py-20' }, 
          React.createElement('div', { className: 'text-2xl mb-4' }, '⭐ Preparazione calendario...'),
          React.createElement('div', { className: 'text-lg text-gray-300 mt-2' }, `Ciao ${USERS[username]?.displayName || username}!`),
          initError && React.createElement('div', { className: 'text-red-400 text-sm mt-4' }, `Errore: ${initError}`)
        );
      }
      
      console.log('✅ App completamente caricata, rendering calendario con maxDay:', maxDay);

      return React.createElement(
        React.Fragment,
        null,
        
        // Banner informativo Export/Import
        React.createElement(
          "div",
          { className: "mb-4 p-3 bg-blue-900 bg-opacity-50 rounded-lg border border-blue-400" },
          React.createElement("div", { className: "flex items-center gap-2 text-blue-200" },
            React.createElement("span", { className: "text-lg" }, "💡"),
            React.createElement("span", { className: "text-sm font-medium" }, "Usa 'Esporta' per salvare i progressi e 'Importa' per condividerli con altri browser")
          )
        ),
        
        // Messaggio di stato del calendario
        React.createElement(
          "div",
          { className: "mb-6 p-4 bg-blue-900 bg-opacity-50 rounded-xl border border-blue-400" },
          React.createElement("h3", { className: "text-lg font-bold text-blue-200 mb-2" }, "🏆 Stato del Calendario"),
          React.createElement("p", { className: "text-blue-100" }, 
            maxDay > 0 
              ? `✨ Hai accesso ai primi ${maxDay} giorni! Clicca su un giorno per iniziare la sfida.`
              : "🔒 Tutti i giorni sono ancora bloccati. Torna a dicembre per iniziare!"
          ),
          React.createElement("p", { className: "text-blue-200 text-sm mt-1" }, 
            `📅 Data corrente: ${today.toLocaleDateString('it-IT')} | Modalità: ${currentMonth < 11 ? 'Testing Pre-Dicembre' : currentMonth === 11 ? 'Dicembre Ufficiale' : 'Post-Dicembre'}`
          )
        ),
        
        // Griglia giorni con layout migliorato
        React.createElement(
          "div",
          { 
            id: "calendarGrid",
            className: "w-full"
          },
          FULL_CONSTELLATIONS.map((c, i) => {
            const index = i + 1;
            const entry = progress[i] || { attempts: 0, solved: false, score: 3, usedHints: 0 };
            const locked = index > maxDay;
            
            // Debug per ogni giorno
            if (i < 10) { // Solo primi 10 giorni per evitare spam
              console.log(`Giorno ${index}: ${locked ? 'BLOCCATO' : 'SBLOCCATO'} (maxDay=${maxDay})`);
            }

            function openModal() {
              if (!locked) {
                setActiveModal(i);
                setFeedback("");
                setWrongAnswer(null);
                
                // BUG FIX #1: Mescola opzioni UNA VOLTA all'apertura del modal
                if (!shuffledOptions[i]) {
                  const mixed = shuffleArray([...FULL_CONSTELLATIONS[i].options]);
                  setShuffledOptions(prev => ({ ...prev, [i]: mixed }));
                  console.log(`🎲 Opzioni mescolate per giorno ${i + 1}:`, mixed);
                }
              }
            }

            return React.createElement(
              "div",
              {
                key: i,
                className: `calendar-day ${locked ? 'locked' : entry.solved ? 'completed' : 'available'}`,
                onClick: openModal,
                'data-day': index
              },
              React.createElement("h2", null, `Giorno ${index}`),
              React.createElement("div", { className: "day-icon" }, 
                locked ? "🔒" : entry.solved ? "🎆" : "✨"
              ),
              React.createElement("div", { className: "day-status" },
                locked 
                  ? `Bloccato fino al ${index} dicembre`
                  : entry.solved 
                    ? (() => {
                        const finalScore = entry.finalScore !== undefined ? entry.finalScore : entry.score;
                        const displayScore = finalScore >= 0 ? `+${finalScore}` : `${finalScore}`;
                        return `Completato! ⭐ ${displayScore}`;
                      })()
                    : "🔹 Clicca per iniziare!"
              )
            );
          })
        ),
        
        // Modal gioco
        activeModal !== null && React.createElement(
          "div",
          { className: "full-screen-modal" },
          React.createElement("button", { className: "close-button", onClick: () => setActiveModal(null) }, "×"),
          React.createElement("div", { className: "modal-content" },
            React.createElement("h2", { className: "text-3xl font-bold mb-4" }, `✨ Giorno ${activeModal + 1}`),
            React.createElement("div", { className: "mb-4 text-center" },
              React.createElement("div", { 
                className: "w-64 h-64 mx-auto bg-gradient-to-br from-blue-900 via-purple-900 to-indigo-900 rounded-lg flex flex-col items-center justify-center text-white border-2 border-yellow-400 shadow-lg",
                style: { backgroundImage: 'radial-gradient(circle at 30% 30%, rgba(255,255,255,0.1) 1px, transparent 1px), radial-gradient(circle at 70% 70%, rgba(255,255,255,0.08) 1px, transparent 1px)' }
              },
                React.createElement("div", { className: "text-6xl mb-2" }, "✨"),
                React.createElement("div", { className: "text-lg font-bold" }, FULL_CONSTELLATIONS[activeModal].name),
                React.createElement("div", { className: "text-sm text-gray-300 mt-2 px-4 text-center" }, "Osserva attentamente le stelle di questa costellazione")
              )
            ),
            !progress[activeModal]?.solved && React.createElement(React.Fragment, null,
              React.createElement("p", { className: "mb-4 text-lg" }, "Quale costellazione è questa?"),
              React.createElement("div", { className: "flex flex-col gap-3" },
                // BUG FIX #1: Usa opzioni mescolate invece dell'ordine originale
                (shuffledOptions[activeModal] || FULL_CONSTELLATIONS[activeModal].options).map((opt, j) => {
                  const isWrong = wrongAnswer === opt;
                  const isCorrect = progress[activeModal]?.solved && opt === FULL_CONSTELLATIONS[activeModal].name;
                  return React.createElement("button", {
                    key: j,
                    onClick: () => handleAnswer(activeModal, opt),
                    className: `option-button px-4 py-2 rounded-lg shadow transition-all ${
                      isCorrect ? 'bg-green-600 hover:bg-green-700' : 
                      isWrong ? 'bg-red-600 hover:bg-red-700' : 
                      'bg-blue-600 hover:bg-blue-700'
                    }`
                  }, opt);
                })
              ),
              feedback && React.createElement("div", { className: `feedback ${feedback.includes('Corretto') ? 'correct' : feedback.includes('sbagliata') ? 'wrong' : ''}` }, feedback),
              // BUG FIX #2: DISPLAY CORRETTO DEI PUNTI
              React.createElement("div", { className: "mt-4 p-3 bg-gray-800 rounded-lg text-center" },
                React.createElement("div", { className: "text-lg font-bold text-yellow-300" }, 
                  (() => {
                    const currentScore = progress[activeModal]?.score ?? 3;
                    const displayScore = currentScore >= 0 ? `+${currentScore}` : `${currentScore}`;  // BUG FIX: NO +-2 ma -2
                    return `⭐ Punti attuali: ${displayScore}`;
                  })()
                ),
                React.createElement("div", { className: "text-sm text-gray-400 mt-1" }, 
                  (() => {
                    const currentScore = progress[activeModal]?.score ?? 3;
                    const hints = progress[activeModal]?.usedHints || 0;
                    const errors = Math.max(0, (progress[activeModal]?.attempts || 0) - (progress[activeModal]?.solved ? 1 : 0));
                    return `Formula: 3 - ${hints} indizi - ${errors} errori = ${currentScore}`;
                  })()
                ),
                progress[activeModal]?.score < 0 && React.createElement("div", { className: "text-sm text-red-400 font-bold mt-1" }, 
                  "⚠️ Attenzione: sei in punteggio negativo!"
                )
              ),
              React.createElement("div", { className: "mt-4 flex justify-between items-center" },
                React.createElement("button", { 
                  onClick: () => useHint(activeModal), 
                  className: "text-sm text-yellow-400 underline hover:text-yellow-300",
                  disabled: (progress[activeModal]?.usedHints || 0) >= 3
                }, `💡 Usa indizio (${progress[activeModal]?.usedHints || 0}/3)`),
                React.createElement("p", { className: "text-sm" }, 
                  (() => {
                    const currentScore = progress[activeModal]?.score ?? 3;
                    const displayScore = currentScore >= 0 ? `+${currentScore}` : `${currentScore}`;  // BUG FIX #2
                    return `⭐ Punti: ${displayScore}`;
                  })()
                )
              )
            ),
            progress[activeModal]?.solved && React.createElement("div", { className: "mt-6 text-lg space-y-4" },
              React.createElement("h3", { className: "text-xl font-bold text-yellow-400" }, FULL_CONSTELLATIONS[activeModal].name),
              React.createElement("p", { className: "text-gray-300" }, FULL_CONSTELLATIONS[activeModal].description),
              React.createElement("div", { className: "bg-gray-800 p-4 rounded-lg" },
                React.createElement("h4", { className: "font-semibold mb-2" }, "📊 Statistiche:"),
                React.createElement("p", { className: "text-sm text-gray-300" }, `❌ Tentativi sbagliati: ${(progress[activeModal]?.attempts || 1) - 1}`),
                React.createElement("p", { className: "text-sm text-gray-300" }, `💡 Indizi usati: ${progress[activeModal]?.usedHints || 0}`),
                React.createElement("p", { className: "text-sm text-yellow-300 font-semibold" }, `⭐ Punteggio ottenuto: ${progress[activeModal]?.score || 0}`)
              )
            )
          )
        ),
        
        // Modal impostazioni
        settingsModal && React.createElement(
          "div",
          { className: "full-screen-modal" },
          React.createElement("button", { className: "close-button", onClick: () => setSettingsModal(false) }, "×"),
          React.createElement("div", { className: "modal-content max-w-2xl" },
            React.createElement("h2", { className: "text-3xl font-bold mb-6" }, "⚙️ Impostazioni"),
            
            // Sezione utente
            React.createElement("div", { className: "backup-section" },
              React.createElement("h3", { className: "text-xl font-semibold mb-4" }, "👤 Profilo Utente"),
              React.createElement("div", { className: "space-y-3" },
                React.createElement("div", { className: "text-center" },
                  React.createElement("div", { className: "text-lg font-semibold text-white mb-2" }, `👤 ${USERS[username]?.displayName || username}`),
                  React.createElement("p", { className: "text-sm text-gray-400" }, 
                    "Il tuo nome utente e display name sono gestiti dal sistema di login."
                  )
                )
              )
            ),
            
            // Statistiche
            React.createElement("div", { className: "backup-section" },
              React.createElement("h3", { className: "text-xl font-semibold mb-4" }, "📊 Statistiche"),
              React.createElement("div", { className: "stats-grid" },
                React.createElement("div", { className: "stat-card" },
                  React.createElement("div", { className: "text-2xl font-bold text-yellow-400" }, stats.totalScore || 0),
                  React.createElement("div", { className: "text-sm text-gray-400" }, "Punti Totali")
                ),
                React.createElement("div", { className: "stat-card" },
                  React.createElement("div", { className: "text-2xl font-bold text-green-400" }, stats.completedDays || 0),
                  React.createElement("div", { className: "text-sm text-gray-400" }, "Giorni Completati")
                ),
                React.createElement("div", { className: "stat-card" },
                  React.createElement("div", { className: "text-2xl font-bold text-blue-400" }, stats.totalAttempts || 0),
                  React.createElement("div", { className: "text-sm text-gray-400" }, "Tentativi Totali")
                ),
                React.createElement("div", { className: "stat-card" },
                  React.createElement("div", { className: "text-2xl font-bold text-purple-400" }, stats.totalHints || 0),
                  React.createElement("div", { className: "text-sm text-gray-400" }, "Indizi Usati")
                )
              )
            ),
            
            // Backup e ripristino
            React.createElement("div", { className: "backup-section" },
              React.createElement("h3", { className: "text-xl font-semibold mb-4" }, "💾 Backup &amp; Ripristino"),
              React.createElement("p", { className: "text-sm text-gray-400 mb-4" }, 
                "Usa queste funzioni per salvare o ripristinare il tuo progresso su altri dispositivi. I codici di backup sono sicuri e contengono tutti i tuoi dati."
              ),
              React.createElement("div", { className: "space-y-4" },
                React.createElement("div", null,
                  React.createElement("button", {
                    onClick: exportUserProgress,
                    className: "w-full px-4 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors mb-2"
                  }, "📤 Genera Codice di Backup"),
                  React.createElement("p", { className: "text-sm text-gray-400" }, "Copia il codice per salvare il tuo progresso")
                ),
                React.createElement("div", null,
                  React.createElement("input", {
                    id: "import-input",
                    type: "text",
                    placeholder: "Incolla qui il codice di backup",
                    className: "w-full px-3 py-2 bg-gray-700 rounded border border-gray-600 text-white mb-2"
                  }),
                  React.createElement("button", {
                    onClick: () => {
                      const code = document.getElementById('import-input').value;
                      if (code) importUserProgress(code);
                    },
                    className: "w-full px-4 py-3 bg-green-600 hover:bg-green-700 rounded-lg transition-colors"
                  }, "📥 Importa Progresso")
                ),
                React.createElement("div", null,
                  React.createElement("button", {
                    onClick: resetUserProgress,
                    className: "w-full px-4 py-3 bg-red-600 hover:bg-red-700 rounded-lg transition-colors"
                  }, "🗑️ Reset Completo"),
                  React.createElement("p", { className: "text-sm text-gray-400 mt-1" }, "⚠️ Questa azione cancellerà tutto il progresso in modo permanente")
                )
              )
            ),
            
            // Info tecnica
            React.createElement("div", { className: "backup-section" },
              React.createElement("h3", { className: "text-xl font-semibold mb-4" }, "ℹ️ Informazioni"),
              React.createElement("div", { className: "text-sm text-gray-400 space-y-2" },
                React.createElement("p", null, `🗄️ Salvataggio: ${dataManager.fallbackToMemory ? 'Memoria Temporanea' : 'IndexedDB (Persistente)'}`),
                React.createElement("p", null, `📅 Ultima sincronizzazione: ${new Date().toLocaleString('it-IT')}`),
                React.createElement("p", null, `📱 Versione: 2.0 - Calendario Costellazioni`),
                React.createElement("p", null, `🌟 Giorni disponibili: ${maxDay}/31`)
              )
            )
          )
        )
      );
    }



    // ========================================
    // FUNZIONI EXPORT/IMPORT COMPLETE
    // ========================================
    
    function exportProgress() {
      try {
        // Crea un oggetto con tutti i dati
        const exportData = {
          version: "1.0",
          timestamp: new Date().toISOString(),
          users: window.ADVENT_DATA.users
        };
        
        // Converti in stringa e codifica
        const jsonString = JSON.stringify(exportData);
        const encoded = btoa(jsonString);
        const finalCode = `ADVENT_${encoded}`;
        
        // Mostra il codice all'utente
        showExportModal(finalCode);
        
        console.log('📤 Dati esportati con successo');
        return finalCode;
        
      } catch (error) {
        console.error('❌ Errore esportazione:', error);
        alert('Errore durante l\'esportazione');
      }
    }

    function importProgress() {
      const code = prompt('Inserisci il codice di backup:');
      
      if (!code) return;
      
      try {
        // Rimuovi prefisso se presente
        const cleanCode = code.replace('ADVENT_', '');
        
        // Decodifica
        const jsonString = atob(cleanCode);
        const importData = JSON.parse(jsonString);
        
        // Verifica formato
        if (!importData.users) {
          throw new Error('Formato codice non valido');
        }
        
        // Importa i dati
        window.ADVENT_DATA.users = {
          ...window.ADVENT_DATA.users,
          ...importData.users
        };
        
        // Aggiorna interfaccia se l'utente corrente è presente nei dati importati
        if (currentUser && importData.users[currentUser]) {
          // Trigger React re-render by updating some global state
          window.dispatchEvent(new CustomEvent('dataImported'));
        }
        
        alert('✅ Dati importati con successo!');
        console.log('📥 Dati importati:', importData);
        
        // Ricarica la pagina per aggiornare tutto
        setTimeout(() => {
          location.reload();
        }, 1000);
        
      } catch (error) {
        console.error('❌ Errore importazione:', error);
        alert('❌ Codice non valido o danneggiato');
      }
    }

    function showExportModal(code) {
      const modal = document.createElement('div');
      modal.className = 'export-modal';
      modal.innerHTML = `
        <div class="export-content">
          <h2>📤 Codice di Backup</h2>
          <p>Copia questo codice per salvare i tuoi progressi:</p>
          <textarea readonly class="export-code">${code}</textarea>
          <div class="export-buttons">
            <button onclick="copyToClipboard('${code}')" class="copy-btn">📋 Copia</button>
            <button onclick="closeExportModal()" class="close-btn">Chiudi</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Auto-select text
      const textarea = modal.querySelector('.export-code');
      if (textarea) {
        textarea.select();
      }
    }

    function closeExportModal() {
      const modal = document.querySelector('.export-modal');
      if (modal) {
        modal.remove();
      }
    }

    function copyToClipboard(text) {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
          alert('✅ Codice copiato negli appunti!');
          closeExportModal();
        }).catch(() => {
          // Fallback
          fallbackCopyToClipboard(text);
        });
      } else {
        // Fallback per browser vecchi
        fallbackCopyToClipboard(text);
      }
    }

    function fallbackCopyToClipboard(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.top = '0';
      textArea.style.left = '0';
      textArea.style.width = '2em';
      textArea.style.height = '2em';
      textArea.style.padding = '0';
      textArea.style.border = 'none';
      textArea.style.outline = 'none';
      textArea.style.boxShadow = 'none';
      textArea.style.background = 'transparent';
      document.body.appendChild(textArea);
      textArea.select();
      
      try {
        const successful = document.execCommand('copy');
        if (successful) {
          alert('✅ Codice copiato negli appunti!');
        } else {
          alert('❌ Impossibile copiare automaticamente. Seleziona e copia manualmente.');
        }
      } catch (err) {
        alert('❌ Impossibile copiare automaticamente. Seleziona e copia manualmente.');
      }
      
      document.body.removeChild(textArea);
      closeExportModal();
    }

    // ========================================
    // CLASSIFICA CON MEMORIA PURA
    // ========================================
    function showLeaderboard() {
      if (!currentUser) {
        console.error('❌ Nessun utente loggato per la classifica');
        return;
      }
      
      console.log('=== CARICAMENTO CLASSIFICA DA MEMORIA ===');
      console.log('👤 Utente corrente:', currentUser);
      
      try {
        // Ottieni classifica dalla memoria
        const leaderboardData = getLeaderboard();
        console.log('📊 Risultati classifica da memoria:', leaderboardData);
        
        // Crea modal classifica
        const modal = document.createElement('div');
        modal.className = 'full-screen-modal';
        
        console.log('🎨 Creazione modal con dati finali:', leaderboardData);
        
        const content = leaderboardData.length === 0 ? 
          `<div style="text-align: center; padding: 2rem;">
            <h3 style="color: #888; margin-bottom: 1rem;">🤷‍♂️ Nessun dato disponibile</h3>
            <p style="color: #666; font-size: 0.9rem;">Completa almeno un giorno per apparire in classifica!</p>
            <div style="margin-top: 1rem; font-size: 0.8rem; color: #555; font-family: monospace;">
              <p>Debug: Utente = ${currentUser}</p>
              <p>Modalità: Memoria JavaScript pura</p>
              <p>Utenti nella memoria: ${Object.keys(window.ADVENT_DATA.users).join(', ')}</p>
              <p>Progressi trovati: ${Object.keys(window.ADVENT_DATA.users).map(u => Object.keys(window.ADVENT_DATA.users[u].progress).length).join(', ')}</p>
            </div>
          </div>` :
          leaderboardData.map((user, index) => {
            const isCurrentUser = user.username === currentUser;
            const scoreColor = user.score >= 0 ? '#FFD700' : '#FF6B6B';
            const scoreText = user.score >= 0 ? user.score : `${user.score} (negativo)`;
            
            return `
              <div class="leaderboard-row ${isCurrentUser ? 'current-user' : ''}">
                <div style="display: flex; align-items: center; gap: 1rem;">
                  <div class="rank-badge ${index === 0 ? 'first' : index === 1 ? 'second' : index === 2 ? 'third' : ''}">
                    ${index + 1}
                  </div>
                  <div>
                    <div style="font-weight: bold; color: white;">
                      ${user.name} ${isCurrentUser ? '(Tu)' : ''}
                    </div>
                    <div style="font-size: 0.9rem; color: #ccc;">
                      ${user.days}/31 giorni completati
                    </div>
                  </div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 1.5rem; font-weight: bold; color: ${scoreColor};">
                    ⭐ ${scoreText}
                  </div>
                </div>
              </div>
            `;
          }).join('');
        
        modal.innerHTML = `
          <button class="close-button" onclick="this.parentElement.remove()">×</button>
          <div class="leaderboard">
            <h2 class="leaderboard-title">🏆 Classifica Generale</h2>
            <div style="margin-bottom: 1rem; text-align: center; font-size: 0.9rem; color: #999;">
              Aggiornata: ${new Date().toLocaleTimeString('it-IT')}
            </div>
            <div style="margin-bottom: 1rem; text-align: center; font-size: 0.8rem; color: #666; background: rgba(255,215,0,0.1); padding: 0.5rem; border-radius: 0.5rem;">
              ⚠️ Dati salvati solo in questa sessione. Usa 'Esporta' per backup permanente.
            </div>
            ${content}
          </div>
        `;
        
        document.body.appendChild(modal);
        console.log('✅ Classifica mostrata con successo');
        
      } catch (error) {
        console.error('❌ Errore caricamento classifica:', error);
        showToast('Errore caricamento classifica', 'error');
      }
    }
    
    // Inizializzazione sicura DOM
    document.addEventListener('DOMContentLoaded', function() {
      console.log('🚀 DOM caricato, inizializzando sistema...');
      
      // Verifica elementi critici
      const criticalElements = ['loginScreen', 'mainApp', 'usernameInput', 'passwordInput', 'loginBtn'];
      const missing = criticalElements.filter(id => !document.getElementById(id));
      
      if (missing.length > 0) {
        console.error('❌ Elementi DOM critici mancanti:', missing);
        document.body.innerHTML = '<div style="text-align: center; padding: 2rem; color: white; background: #000;"><h1>❌ Errore caricamento</h1><p>Elementi mancanti: ' + missing.join(', ') + '</p><button onclick="location.reload()">Ricarica Pagina</button></div>';
        return;
      }
      
      console.log('✅ Tutti gli elementi critici trovati, inizializzando LoginManager...');
      
      // Initialize login screen solo se tutto OK
      try {
        ReactDOM.createRoot(document.createElement('div')).render(React.createElement(LoginManager));
        console.log('✅ LoginManager inizializzato con successo');
      } catch (error) {
        console.error('❌ Errore inizializzazione LoginManager:', error);
        showToast('Errore sistema login', 'error');
      }
    });
  </script>
</body>
</html>
